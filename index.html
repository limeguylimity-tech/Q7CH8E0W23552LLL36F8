<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GHOSTCORD v6.6</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{--c1:#00ffff;--c2:#ff00ff;--bg:#0d0d0d;--card:#111;--accent:#1a1a1a;--text:#eee;--border:#333;--online:#00ff00;--idle:#ffaa00;--dnd:#ff5555;--invisible:#666;--radius:8px;--transition:all .2s ease;}
    [data-theme="light"]{--bg:#f5f5f5;--card:#fff;--accent:#eee;--text:#222;--border:#ddd;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;flex-direction:column;height:100vh;overflow:hidden;background-image:var(--wallpaper,none);background-size:cover;background-position:center;}
    #notifications{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--card);padding:10px 20px;border-radius:var(--radius);border:2px solid var(--c1);z-index:10000;display:none;box-shadow:0 0 10px rgba(0,255,255,.5);}
    #loginScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:9999;}
    #loginBox{background:var(--card);padding:32px;border-radius:var(--radius);width:340px;box-shadow:0 0 40px rgba(0,255,255,.3);border:2px solid var(--c1);}
    #loginBox h2{color:var(--c1);text-align:center;margin-bottom:20px;font-size:24px;font-weight:600;}
    .input{width:100%;padding:12px 16px;margin:10px 0;background:var(--accent);border:1px solid var(--c1);border-radius:var(--radius);color:var(--text);font-size:15px;outline:none;transition:var(--transition);}
    .input:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    .btn{background:var(--c1);color:#000;padding:12px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;width:100%;margin-top:10px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    .btn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    .switch{text-align:center;margin-top:16px;color:#aaa;font-size:13px;}
    .switch a{color:var(--c2);cursor:pointer;text-decoration:underline;}
    @keyframes aura-pulse{0%{box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}50%{box-shadow:0 0 20px var(--c1),0 0 40px rgba(0,255,255,.8);}100%{box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}}
    #topBar{background:rgba(0,0,0,.7);padding:8px 16px;color:#ccc;font-size:13px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);display:flex;justify-content:space-between;align-items:center;}
    #topBarLeft{display:flex;align-items:center;gap:16px;}
    #topBarCenter{flex:1;display:flex;justify-content:center;}
    #topBarRight{display:flex;align-items:center;gap:16px;}
    #userInfo{display:flex;align-items:center;gap:10px;padding:4px 12px;background:rgba(0,255,255,.1);border-radius:20px;border:1px solid var(--c1);}
    #userAvatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--c1);object-fit:cover;}
    #userDetails{display:flex;flex-direction:column;gap:2px;}
    #userName{font-weight:600;color:var(--c1);font-size:13px;}
    #userStatus{font-size:10px;color:var(--online);}
    #clock{color:var(--c1);font-weight:600;}
    #playersOnline{color:var(--c1);font-weight:600;padding:4px 12px;background:rgba(255,0,255,.1);border-radius:20px;border:1px solid var(--c2);}
    #tabs{display:flex;background:rgba(0,0,0,.85);border-bottom:2px solid var(--c1);backdrop-filter:blur(12px);user-select:none;}
    .tab{padding:14px 24px;cursor:pointer;font-weight:600;font-size:14px;transition:var(--transition);color:#ccc;position:relative;}
    .tab:hover{background:var(--accent);}
    .tab.active{background:var(--accent);color:var(--c1);}
    .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:2px;background:var(--c1);}
    #app{flex:1;display:flex;overflow:hidden;}
    #servers{width:72px;background:rgba(0,0,0,.8);padding:12px 0;display:flex;flex-direction:column;align-items:center;gap:12px;border-right:1px solid var(--border);overflow-y:auto;}
    .srv{width:48px;height:48px;border-radius:50%;background:var(--c1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#000;box-shadow:0 0 12px rgba(0,255,255,.5);transition:var(--transition);position:relative;flex-shrink:0;}
    .srv:hover{transform:scale(1.1);border-radius:35%;}
    .srv.add{background:var(--c2);font-size:28px;}
    .srv.active{border:3px solid #0f0;}
    .srv::after{content:attr(data-name);position:absolute;left:64px;top:50%;transform:translateY(-50%);background:#000;color:#fff;padding:6px 10px;border-radius:4px;font-size:12px;opacity:0;transition:var(--transition);border:1px solid var(--c1);white-space:nowrap;z-index:100;}
    .srv:hover::after{opacity:1;}
    #main{flex:1;display:flex;overflow:hidden;}
    #channels{width:240px;background:rgba(17,17,17,.9);padding:16px 8px;border-right:2px solid var(--c1);overflow-y:auto;backdrop-filter:blur(10px);display:flex;flex-direction:column;}
    #channels h3{color:var(--c1);margin:0 8px 12px;font-size:13px;text-transform:uppercase;letter-spacing:1px;font-weight:600;}
    #channelList{flex:1;overflow-y:auto;}
    .chan{padding:8px 12px;margin:2px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition);font-size:14px;display:flex;justify-content:space-between;align-items:center;color:#ccc;}
    .chan:hover,.chan.active{background:var(--accent);color:var(--c1);}
    .chan .delete{color:#f55;font-size:10px;cursor:pointer;opacity:0;transition:var(--transition);}
    .chan:hover .delete{opacity:1;}
    #chatArea{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden;}
    #chatHeader{padding:12px 16px;background:rgba(0,0,0,.8);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    #chatHeader h3{color:var(--c1);font-size:16px;}
    #clearChatBtn{background:#f55;color:#000;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:var(--transition);}
    #clearChatBtn:hover{background:#f77;}
    #messages, #globalMessages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    .msg{max-width:70%;padding:12px 16px;background:var(--card);border-left:4px solid var(--c1);border-radius:var(--radius);align-self:flex-start;word-wrap:break-word;box-shadow:0 1px 3px rgba(0,0,0,.2);}
    .msg.own{align-self:flex-end;background:#1a1a1a;border-left:none;border-right:4px solid var(--c2);}
    .msg strong{color:var(--c2);}
    #inputArea, #globalInputArea{position:sticky;bottom:0;background:rgba(0,0,0,.9);padding:16px;border-top:2px solid var(--c2);gap:12px;align-items:center;backdrop-filter:blur(10px);z-index:1002;display:flex;}
    #msgInput, #dmInput, #globalMsgInput{flex:1;background:var(--card);border:2px solid transparent;color:var(--text);padding:14px 18px;border-radius:12px;outline:none;font-size:16px;min-height:50px;resize:none;transition:var(--transition);}
    #msgInput:focus, #dmInput:focus, #globalMsgInput:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    #sendBtn, #dmSendBtn, #globalSendBtn{background:var(--c1);color:#000;border:none;padding:0 24px;border-radius:12px;cursor:pointer;font-weight:bold;height:50px;min-width:80px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    #sendBtn:hover, #dmSendBtn:hover, #globalSendBtn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #dmView,#friendsView,#newsView,#shopView,#gamesView,#settingsView,#globalView,#serverListView{flex:1;display:none;flex-direction:column;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);position:relative;overflow:hidden;}
    #dmHeader,#globalHeader,#serverListHeader{padding:16px;border-bottom:1px solid var(--border);font-weight:600;color:var(--c1);display:flex;justify-content:space-between;align-items:center;}
    #dmMessages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    #dmList,#friendsList,#newsFeed,#shopItems,#gameContainer,#serverList{padding:20px;overflow-y:auto;flex:1;}
    .dm-user,.friend,.server-item{padding:12px 16px;margin:8px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px;background:var(--card);border-left:4px solid var(--c1);transition:var(--transition);}
    .dm-user:hover,.friend:hover,.server-item:hover{background:var(--accent);transform:translateX(4px);}
    .server-item{flex-direction:column;align-items:flex-start;}
    .server-item h4{color:var(--c1);margin-bottom:6px;}
    .server-item p{color:#aaa;font-size:12px;}
    .server-actions{display:flex;gap:8px;margin-top:8px;}
    .join-btn{background:var(--c1);color:#000;padding:4px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:11px;}
    .status-dot{width:10px;height:10px;border-radius:50%;background:var(--online);}
    .offline .status-dot{background:#666;}
    .pending{opacity:.7;}
    .accept-btn,.reject-btn{margin-left:10px;padding:2px 8px;font-size:10px;cursor:pointer;border-radius:var(--radius);}
    .accept-btn{background:var(--online);color:#000;}
    .reject-btn{background:var(--dnd);color:#000;}
    .news-item,.shop-item,.game-container{background:var(--card);padding:12px 16px;border-radius:var(--radius);margin-bottom:12px;border-left:4px solid var(--c1);box-shadow:0 1px 3px rgba(0,0,0,.2);}
    .news-item h4,.shop-item h4,.game-container h4{color:var(--c1);margin-bottom:6px;font-size:16px;font-weight:600;}
    .buy-btn{background:var(--c2);color:#000;padding:6px 12px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:bold;transition:var(--transition);}
    .buy-btn:disabled{background:#666;cursor:not-allowed;}
    #pointsDisplay{color:var(--c1);font-weight:600;margin-bottom:10px;}
    #playBtn{background:var(--c1);color:#000;padding:8px 16px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:bold;transition:var(--transition);}
    #userPanel{display:none;}
    #userAvatar{width:36px;height:36px;border-radius:50%;border:2px solid var(--c1);object-fit:cover;}
    #userName{font-weight:600;}
    #userStatus{font-size:11px;color:var(--online);}
    #connectionStatus{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);padding:16px 32px;border-radius:var(--radius);font-size:14px;font-weight:bold;z-index:10001;display:none;box-shadow:0 0 20px rgba(0,0,0,.5);transition:var(--transition);}
    .status-connected{background:#0f0;color:#000;}
    .status-connecting{background:#fa0;color:#000;}
    .btn-small{background:var(--c1);color:#000;padding:6px 10px;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:bold;margin:5px 8px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    .btn-small.invite{background:var(--c2);}
    #settingsView{padding:20px;overflow-y:auto;}
  </style>
</head>
<body>
  <div id="notifications"></div>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div id="loginBox">
      <h2 id="loginTitle">Sign In</h2>
      <input id="username" class="input" placeholder="Username" type="text">
      <input id="password" class="input" placeholder="Password" type="password">
      <button id="authBtn" class="btn">Sign In</button>
      <div class="switch"><span id="switchText">Don't have an account? </span><a id="switchLink">Create one</a></div>
    </div>
  </div>

  <!-- TOP BAR -->
  <div id="topBar">
    <div id="topBarLeft">
      <div id="userInfo">
        <img id="userAvatar" src="https://i.imgur.com/6VBx3io.png" alt="avatar">
        <div id="userDetails">
          <span id="userName"></span>
          <span id="userStatus"></span>
        </div>
      </div>
    </div>
    <div id="topBarCenter">
      <div id="clock"></div>
    </div>
    <div id="topBarRight">
      <div id="playersOnline">Players: 0</div>
    </div>
  </div>

  <!-- TABS -->
  <div id="tabs">
    <div class="tab active" data-tab="home">Home</div>
    <div class="tab" data-tab="serverlist">Servers</div>
    <div class="tab" data-tab="dms">DMs</div>
    <div class="tab" data-tab="friends">Friends</div>
    <div class="tab" data-tab="news">News</div>
    <div class="tab" data-tab="shop">Shop</div>
    <div class="tab" data-tab="games">Games</div>
    <div class="tab" data-tab="global">Global</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- HOME -->
  <div id="app">
    <div id="servers">
      <div class="srv add" id="addServerBtn">+</div>
    </div>
    <div id="main">
      <div id="channels">
        <h3>Channels</h3>
        <div id="channelList"></div>
        <button id="addChannelBtn" class="btn-small">+ Channel</button>
      </div>
      <div id="chatArea">
        <div id="chatHeader">
          <h3 id="chatTitle">Select a channel</h3>
          <button id="clearChatBtn">Clear Chat</button>
        </div>
        <div id="messages"></div>
        <div id="inputArea">
          <textarea id="msgInput" placeholder="Select a server..."></textarea>
          <button id="sendBtn" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SERVER LIST -->
  <div id="serverListView">
    <div id="serverListHeader">
      <h3>All Servers</h3>
    </div>
    <div id="serverList"></div>
  </div>

  <!-- DMs -->
  <div id="dmView">
    <div id="dmHeader">
      <span>Select a DM</span>
      <button id="clearDmBtn" class="btn-small" style="background:#f55;">Clear</button>
    </div>
    <div id="dmMessages"></div>
    <div id="inputArea">
      <textarea id="dmInput" placeholder="Select a DM..."></textarea>
      <button id="dmSendBtn" disabled>Send</button>
    </div>
  </div>

  <!-- Global Chat -->
  <div id="globalView">
    <div id="globalHeader">
      <span>Global Chat</span>
      <button id="clearGlobalBtn" class="btn-small" style="background:#f55;">Clear</button>
    </div>
    <div id="globalMessages"></div>
    <div id="globalInputArea">
      <textarea id="globalMsgInput" placeholder="Say something..."></textarea>
      <button id="globalSendBtn">Send</button>
    </div>
  </div>

  <!-- Friends, News, Shop, Games -->
  <div id="friendsView">
    <input id="addFriendInput" class="input" placeholder="Add friend...">
    <button id="addFriendBtn" class="btn-small">Add</button>
    <div id="friendsList"></div>
  </div>
  <div id="newsView"><div id="newsFeed"></div></div>
  <div id="shopView"><div id="pointsDisplay">Points: 0</div><div id="shopItems"></div></div>
  <div id="gamesView"><div id="gameContainer"><h4>Number Guessing</h4><p id="gameInstructions"></p><div id="gameArea"></div><button id="playBtn">Play</button><p id="gameResult"></p></div></div>

  <!-- Settings -->
  <div id="settingsView">
    <input id="nameInput" class="input" placeholder="Name">
    <input id="bioInput" class="input" placeholder="Bio">
    <select id="themeSelect" class="input"><option value="dark">Dark</option><option value="light">Light</option></select>
    <select id="statusSelect" class="input"><option value="online">Online</option><option value="idle">Idle</option><option value="dnd">DND</option><option value="invisible">Invisible</option></select>
    <input id="avatarInput" type="file" accept="image/*">
    <img id="avatarPreview" src="" style="width:100px;height:100px;border-radius:50%;margin:10px 0;">
    <button id="saveSettingsBtn" class="btn">Save Settings</button>
    <button id="logoutBtn" class="btn">Logout</button>
  </div>

  <!-- USER PANEL -->
  <div id="userPanel">
    <img id="userAvatar" src="https://i.imgur.com/6VBx3io.png" alt="avatar">
    <span id="userName"></span>
    <span id="userStatus"></span>
    <span id="userBio"></span>
  </div>

  <!-- CONNECTION POPUP -->
  <div id="connectionStatus" class="status-connecting" style="display:block;">Connecting...</div>

  <script>
    const socket = io(location.origin, { transports: ['websocket', 'polling'] });
    let myName = null, currentServer = null, currentChannel = null, currentDM = null;
    let servers = {}, onlineUsers = {}, messages = {}, friends = {}, points = 0, allServers = {};

    const els = {
      loginScreen: document.getElementById('loginScreen'),
      notifications: document.getElementById('notifications'),
      clock: document.getElementById('clock'),
      playersOnline: document.getElementById('playersOnline'),
      userAvatar: document.getElementById('userAvatar'),
      userName: document.getElementById('userName'),
      userStatus: document.getElementById('userStatus'),
      connectionStatus: document.getElementById('connectionStatus'),
      globalMessages: document.getElementById('globalMessages'),
      globalMsgInput: document.getElementById('globalMsgInput'),
      globalSendBtn: document.getElementById('globalSendBtn'),
      chatTitle: document.getElementById('chatTitle'),
      clearChatBtn: document.getElementById('clearChatBtn'),
      clearDmBtn: document.getElementById('clearDmBtn'),
      clearGlobalBtn: document.getElementById('clearGlobalBtn')
    };

    function show(msg) { els.notifications.textContent = msg; els.notifications.style.display = 'block'; setTimeout(() => els.notifications.style.display = 'none', 3000); }

    // LOGIN
    let isSignup = false;
    document.getElementById('authBtn').onclick = () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) return show('Fill all');
      isSignup ? signup(u, p) : login(u, p);
    };
    document.getElementById('switchLink').onclick = () => {
      isSignup = !isSignup;
      document.getElementById('loginTitle').textContent = isSignup ? 'Create Account' : 'Sign In';
      document.getElementById('authBtn').textContent = isSignup ? 'Sign Up' : 'Sign In';
    };

    function signup(u, p) {
      if (u.length < 3 || p.length < 4) return show('Username 3+, Password 4+');
      const key = `user_${u}`;
      if (localStorage.getItem(key)) return show('Taken');
      localStorage.setItem(key, JSON.stringify({ password: p, points: 0, servers: {}, settings: {}, friends: {} }));
      show('Created');
      login(u, p);
    }

    function login(u, p) {
      const key = `user_${u}`;
      const data = localStorage.getItem(key);
      if (!data || JSON.parse(data).password !== p) return show('Wrong');
      localStorage.setItem('ghostcordAccount', JSON.stringify({ username: u, password: p }));
      els.loginScreen.style.display = 'none';
      myName = u;
      initApp();
    }

    const saved = localStorage.getItem('ghostcordAccount');
    if (saved) { const { username, password } = JSON.parse(saved); login(username, password); }

    function initApp() {
      const userData = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
      servers = userData.servers || {};
      points = userData.points || 0;
      messages = JSON.parse(localStorage.getItem('ghostcordMessages') || '{}');
      friends = userData.friends || {};

      socket.emit('join', { name: myName });

      socket.on('connect', () => { 
        els.connectionStatus.textContent = '✓ Connected'; 
        els.connectionStatus.className = 'status-connected';
        els.connectionStatus.style.display = 'block';
        setTimeout(() => {
          els.connectionStatus.style.display = 'none';
        }, 2000);
      });
      socket.on('users', list => { onlineUsers = list; updatePlayers(); updateFriendsList(); });
      socket.on('userOnline', d => { onlineUsers[d.name] = 'online'; updatePlayers(); updateFriendsList(); });
      socket.on('userOffline', d => { delete onlineUsers[d.name]; updatePlayers(); updateFriendsList(); });

      socket.on('allServers', data => {
        allServers = data;
        if (document.getElementById('serverListView').style.display !== 'none') {
          renderServerList();
        }
      });

      socket.on('channelMessage', data => {
        const key = `${data.server}:${data.channel}`;
        messages[key] = messages[key] || [];
        messages[key].push(data.msg);
        saveMessages();
        if (currentServer === data.server && currentChannel === data.channel) {
          appendMessage(data.msg, document.getElementById('messages'));
        }
      });

      socket.on('globalMessage', msg => {
        messages.global = messages.global || [];
        messages.global.push(msg);
        saveMessages();
        if (document.getElementById('globalView').style.display !== 'none') {
          appendMessage(msg, els.globalMessages);
        }
      });

      socket.on('friendRequest', d => {
        if (d.from === myName) return;
        friends[d.from] = 'pending';
        saveUserData();
        updateFriendsList();
        show(`Friend request from ${d.from}`);
      });

      socket.on('dm', data => {
        const key = `dm:${data.from}`;
        messages[key] = messages[key] || [];
        messages[key].push(data.msg);
        saveMessages();
        if (currentDM === data.from) {
          const dmMessages = document.getElementById('dmMessages');
          appendMessage(data.msg, dmMessages);
        }
      });

      renderServers();
      loadSettings();
      updateClock(); setInterval(updateClock, 60000);
      bindEvents();
      showTab('home');
      socket.emit('getServers');
    }

    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: '2-digit', minute: '2-digit', hour12: true });
      const date = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      els.clock.textContent = `${time} CST, ${date}`;
    }

    function updatePlayers() { els.playersOnline.textContent = `Players: ${Object.keys(onlineUsers).length}`; }

    function renderServers() {
      const list = document.getElementById('servers');
      list.innerHTML = '<div class="srv add" id="addServerBtn">+</div>';
      Object.entries(servers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'srv';
        if (id === currentServer) div.classList.add('active');
        div.textContent = s.name[0].toUpperCase();
        div.dataset.id = id;
        div.dataset.name = s.name;
        div.onclick = () => switchServer(id);
        list.appendChild(div);
      });
      document.getElementById('addServerBtn').onclick = createServer;
    }

    function renderServerList() {
      const list = document.getElementById('serverList');
      list.innerHTML = '';
      Object.entries(allServers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'server-item';
        const joined = servers[id] ? true : false;
        div.innerHTML = `
          <h4>${s.name}</h4>
          <p>Owner: ${s.owner}</p>
          <p>Channels: ${s.channels.length}</p>
          <p>Members: ${s.members.length}</p>
          <div class="server-actions">
            ${joined ? '<span style="color:var(--online);">✓ Joined</span>' : `<button class="join-btn" onclick="joinServer('${id}')">Join</button>`}
          </div>
        `;
        list.appendChild(div);
      });
    }

    window.joinServer = function(id) {
      const server = allServers[id];
      if (!server) return;
      servers[id] = server;
      if (!servers[id].members.includes(myName)) {
        servers[id].members.push(myName);
      }
      saveUserData();
      socket.emit('joinServer', { serverId: id, username: myName });
      renderServers();
      renderServerList();
      show(`Joined ${server.name}!`);
    };

    function createServer() {
      const name = prompt('Server name:');
      if (!name) return;
      const id = Date.now().toString();
      const newServer = { name, channels: ['general'], members: [myName], owner: myName };
      servers[id] = newServer;
      saveUserData();
      socket.emit('createServer', { serverId: id, server: newServer });
      renderServers();
      switchServer(id);
    }

    function switchServer(id) {
      currentServer = id;
      currentChannel = null;
      const s = servers[id];
      const cl = document.getElementById('channelList');
      cl.innerHTML = '';
      s.channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'chan';
        div.innerHTML = `# ${ch} <span class="delete">×</span>`;
        div.onclick = e => {
          if (e.target.classList.contains('delete')) return removeChannel(ch);
          document.querySelectorAll('.chan').forEach(c => c.classList.remove('active'));
          div.classList.add('active');
          currentChannel = ch;
          els.chatTitle.textContent = `#${ch}`;
          document.getElementById('msgInput').placeholder = `Message #${ch}...`;
          document.getElementById('sendBtn').disabled = false;
          loadMessages(document.getElementById('messages'));
        };
        if (ch === 'general') { div.classList.add('active'); currentChannel = 'general'; els.chatTitle.textContent = '#general'; }
        cl.appendChild(div);
      });
      renderServers();
      const msgContainer = document.getElementById('messages');
      msgContainer.innerHTML = '';
      loadMessages(msgContainer);
      document.getElementById('sendBtn').disabled = false;
    }

    function removeChannel(ch) {
      if (!confirm(`Delete #${ch}?`)) return;
      servers[currentServer].channels = servers[currentServer].channels.filter(c => c !== ch);
      saveUserData();
      switchServer(currentServer);
    }

    function loadMessages(container) {
      const key = getCurrentKey();
      if (!key) return;
      const msgs = messages[key] || [];
      container.innerHTML = '';
      msgs.forEach(m => appendMessage(m, container));
      container.scrollTop = container.scrollHeight;
    }

    function appendMessage(msg, container) {
      const own = msg.user === myName;
      const m = document.createElement('div');
      m.className = `msg ${own ? 'own' : ''}`;
      m.innerHTML = `<strong>[${msg.time}] ${msg.user}:</strong> ${msg.text}`;
      container.appendChild(m);
      container.scrollTop = container.scrollHeight;
    }

    function getCurrentKey() {
      if (currentDM) return `dm:${currentDM}`;
      if (currentChannel && currentServer) return `${currentServer}:${currentChannel}`;
      if (document.getElementById('globalView').style.display !== 'none') return 'global';
      return null;
    }

    function clearChat() {
      const key = getCurrentKey();
      if (!key) return show('No chat selected');
      
      if (confirm('Clear all messages in this chat? (Only clears for you)')) {
        // Clear from local storage only
        if (messages[key]) messages[key] = [];
        saveMessages();
        
        // Clear the visible container
        if (document.getElementById('globalView').style.display !== 'none') {
          els.globalMessages.innerHTML = '';
        } else if (document.getElementById('dmView').style.display !== 'none') {
          document.getElementById('dmMessages').innerHTML = '';
        } else {
          document.querySelector('#chatArea #messages').innerHTML = '';
        }
        
        show('Chat cleared! (Only for you)');
      }
    }

    function sendChannel() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentServer || !currentChannel) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const msg = { user: myName, text, time };
      socket.emit('channelMessage', { server: currentServer, channel: currentChannel, msg });
      input.value = '';
    }

    function sendDM() {
      const input = document.getElementById('dmInput');
      const text = input.value.trim();
      if (!text || !currentDM) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const msg = { user: myName, text, time };
      
      // Save to local messages immediately
      const key = `dm:${currentDM}`;
      messages[key] = messages[key] || [];
      messages[key].push(msg);
      saveMessages();
      
      // Display in your own chat
      const dmMessages = document.getElementById('dmMessages');
      appendMessage(msg, dmMessages);
      
      // Send to the other person
      socket.emit('dm', { to: currentDM, msg });
      input.value = '';
    }

    function sendGlobal() {
      const text = els.globalMsgInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      socket.emit('globalMessage', { text, time });
      els.globalMsgInput.value = '';
    }

    function updateFriendsList() {
      const list = document.getElementById('friendsList');
      if (!list) return;
      list.innerHTML = '';
      Object.entries(friends).forEach(([name, status]) => {
        const div = document.createElement('div');
        div.className = `friend ${status === 'online' ? '' : status === 'pending' ? 'pending' : 'offline'}`;
        const color = status === 'online' ? 'var(--online)' : status === 'pending' ? '#666' : '#666';
        div.innerHTML = `<div class="status-dot" style="background:${color}"></div><span>${name}</span>`;
        if (status === 'pending') {
          const accept = document.createElement('button'); accept.className = 'accept-btn'; accept.textContent = 'Accept';
          accept.onclick = () => {
            friends[name] = 'online';
            saveUserData();
            updateFriendsList();
            socket.emit('acceptFriend', { to: name });
          };
          const reject = document.createElement('button'); reject.className = 'reject-btn'; reject.textContent = 'Reject';
          reject.onclick = () => { delete friends[name]; saveUserData(); updateFriendsList(); };
          div.appendChild(accept); div.appendChild(reject);
        } else {
          div.onclick = () => openDM(name);
        }
        list.appendChild(div);
      });
    }

    function addFriend() {
      const name = document.getElementById('addFriendInput').value.trim();
      if (!name || name === myName || friends[name]) return show('Invalid');
      friends[name] = 'sent'; // Mark as 'sent' instead of 'pending'
      saveUserData();
      updateFriendsList();
      socket.emit('friendRequest', { to: name });
      show(`Sent request to ${name}`);
    }

    function openDM(user) {
      currentDM = user;
      showTab('dms');
      document.querySelector('#dmHeader span').textContent = `@${user}`;
      const dmMessages = document.getElementById('dmMessages');
      loadMessages(dmMessages);
      document.getElementById('dmInput').placeholder = `Message @${user}...`;
      document.getElementById('dmSendBtn').disabled = false;
    }

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('app').style.display = tab === 'home' ? 'flex' : 'none';
      document.getElementById('serverListView').style.display = tab === 'serverlist' ? 'flex' : 'none';
      document.getElementById('dmView').style.display = tab === 'dms' ? 'flex' : 'none';
      document.getElementById('friendsView').style.display = tab === 'friends' ? 'flex' : 'none';
      document.getElementById('newsView').style.display = tab === 'news' ? 'flex' : 'none';
      document.getElementById('shopView').style.display = tab === 'shop' ? 'flex' : 'none';
      document.getElementById('gamesView').style.display = tab === 'games' ? 'flex' : 'none';
      document.getElementById('globalView').style.display = tab === 'global' ? 'flex' : 'none';
      document.getElementById('settingsView').style.display = tab === 'settings' ? 'block' : 'none';

      if (tab === 'global') {
        loadMessages(els.globalMessages);
      }
      if (tab === 'serverlist') {
        socket.emit('getServers');
      }
      if (tab === 'news') updateNews();
      if (tab === 'shop') updateShop();
      if (tab === 'games') initGame();
      if (tab === 'settings') loadSettingsForm();
    }

    function updateNews() {
      const feed = document.getElementById('newsFeed');
      feed.innerHTML = '<div class="news-item"><h4>Welcome!</h4><p>GHOSTCORD v6.6 is live with new features!</p></div>';
      feed.innerHTML += '<div class="news-item"><h4>New Feature</h4><p>Browse all servers in the Servers tab!</p></div>';
      feed.innerHTML += '<div class="news-item"><h4>Clear Chat</h4><p>You can now clear chat history with one click!</p></div>';
    }

    function updateShop() {
      document.getElementById('pointsDisplay').textContent = `Points: ${points}`;
      const items = document.getElementById('shopItems');
      items.innerHTML = '';
      const shop = { glow: {name:'Glow Effect',cost:50}, badge: {name:'VIP Badge',cost:100} };
      Object.entries(shop).forEach(([id, item]) => {
        const d = document.createElement('div'); d.className = 'shop-item';
        d.innerHTML = `<div><h4>${item.name}</h4><p>${item.cost} pts</p></div><button class="buy-btn" ${points < item.cost ? 'disabled' : ''}>Buy</button>`;
        d.querySelector('.buy-btn').onclick = () => {
          if (points >= item.cost) { points -= item.cost; saveUserData(); updateShop(); show(`Bought ${item.name}`); }
        };
        items.appendChild(d);
      });
    }

    function initGame() {
      const target = Math.floor(Math.random() * 100) + 1;
      document.getElementById('gameInstructions').textContent = 'Guess a number between 1-100';
      document.getElementById('gameResult').textContent = '';
      const area = document.getElementById('gameArea');
      area.innerHTML = '';
      const input = document.createElement('input'); input.type = 'number'; input.min = 1; input.max = 100; input.className = 'input';
      const btn = document.createElement('button'); btn.textContent = 'Guess'; btn.className = 'btn-small';
      btn.onclick = () => {
        const guess = parseInt(input.value);
        if (guess === target) { points += 10; saveUserData(); document.getElementById('gameResult').textContent = 'Correct! +10 pts'; setTimeout(initGame, 2000); }
        else document.getElementById('gameResult').textContent = guess < target ? 'Too low!' : 'Too high!';
      };
      area.appendChild(input); area.appendChild(btn);
    }

    function loadSettingsForm() {
      const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}').settings || {};
      document.getElementById('nameInput').value = myName;
      document.getElementById('bioInput').value = data.bio || '';
      document.getElementById('themeSelect').value = data.theme || 'dark';
      document.getElementById('statusSelect').value = data.status || 'online';
      document.getElementById('avatarPreview').src = data.avatar || '';
    }

    function saveSettings() {
      const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
      data.settings = data.settings || {};
      data.settings.bio = document.getElementById('bioInput').value;
      data.settings.theme = document.getElementById('themeSelect').value;
      data.settings.status = document.getElementById('statusSelect').value;
      const file = document.getElementById('avatarInput').files[0];
      if (file) {
        const r = new FileReader();
        r.onload = e => { data.settings.avatar = e.target.result; localStorage.setItem(`user_${myName}`, JSON.stringify(data)); loadSettings(); show('Saved'); };
        r.readAsDataURL(file);
      } else {
        localStorage.setItem(`user_${myName}`, JSON.stringify(data));
        loadSettings();
        show('Saved');
      }
    }

    function logout() {
      if (confirm('Logout?')) {
        localStorage.removeItem('ghostcordAccount');
        location.reload();
      }
    }

    function loadSettings() {
      const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}').settings || {};
      document.body.dataset.theme = data.theme || 'dark';
      document.body.style.setProperty('--wallpaper', data.wallpaper ? `url(${data.wallpaper})` : 'none');
      els.userName.textContent = myName;
      els.userStatus.textContent = data.status || 'online';
      els.userStatus.style.color = { online: 'var(--online)', idle: 'var(--idle)', dnd: 'var(--dnd)', invisible: 'var(--invisible)' }[data.status] || 'var(--online)';
      if (data.avatar) els.userAvatar.src = data.avatar;
    }

    function saveUserData() {
      const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
      data.servers = servers;
      data.points = points;
      data.friends = friends;
      localStorage.setItem(`user_${myName}`, JSON.stringify(data));
    }
    
    function saveMessages() { 
      localStorage.setItem('ghostcordMessages', JSON.stringify(messages)); 
    }

    function bindEvents() {
      document.getElementById('addChannelBtn').onclick = () => {
        const name = prompt('Channel name:');
        if (name && currentServer && !servers[currentServer].channels.includes(name)) {
          servers[currentServer].channels.push(name);
          saveUserData();
          socket.emit('updateServer', { serverId: currentServer, server: servers[currentServer] });
          switchServer(currentServer);
        }
      };
      document.getElementById('sendBtn').onclick = sendChannel;
      document.getElementById('msgInput').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChannel(); } };
      document.getElementById('dmSendBtn').onclick = sendDM;
      document.getElementById('dmInput').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDM(); } };
      els.globalSendBtn.onclick = sendGlobal;
      els.globalMsgInput.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobal(); } };
      document.getElementById('addFriendBtn').onclick = addFriend;
      document.querySelectorAll('.tab').forEach(t => t.onclick = () => showTab(t.dataset.tab));
      document.getElementById('saveSettingsBtn').onclick = saveSettings;
      document.getElementById('logoutBtn').onclick = logout;
      els.clearChatBtn.onclick = clearChat;
      els.clearDmBtn.onclick = clearChat;
      els.clearGlobalBtn.onclick = clearChat;
    }

    socket.on('acceptFriend', d => {
      if (friends[d.from]) friends[d.from] = 'online';
      saveUserData();
      updateFriendsList();
    });
  </script>
</body>
</html>
