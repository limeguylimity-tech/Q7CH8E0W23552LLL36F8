<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GHOSTCORD v6.1</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{--c1:#00ffff;--c2:#ff00ff;--bg:#0d0d0d;--card:#111;--accent:#1a1a1a;--text:#eee;--border:#333;--online:#00ff00;--idle:#ffaa00;--dnd:#ff5555;--invisible:#666;--radius:8px;--transition:all .2s ease;}
    [data-theme="light"]{--bg:#f5f5f5;--card:#fff;--accent:#eee;--text:#222;--border:#ddd;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;flex-direction:column;height:100vh;overflow:hidden;background-image:var(--wallpaper,none);background-size:cover;background-position:center;}
    #notifications{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--card);padding:10px 20px;border-radius:var(--radius);border:2px solid var(--c1);z-index:10000;display:none;box-shadow:0 0 10px rgba(0,255,255,.5);}
    #loginScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:9999;}
    #loginBox{background:var(--card);padding:32px;border-radius:var(--radius);width:340px;box-shadow:0 0 40px rgba(0,255,255,.3);border:2px solid var(--c1);}
    #loginBox h2{color:var(--c1);text-align:center;margin-bottom:20px;font-size:24px;font-weight:600;}
    .input{width:100%;padding:12px 16px;margin:10px 0;background:var(--accent);border:1px solid var(--c1);border-radius:var(--radius);color:var(--text);font-size:15px;outline:none;transition:var(--transition);}
    .input:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    .btn{background:var(--c1);color:#000;padding:12px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;width:100%;margin-top:10px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    .btn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    .switch{text-align:center;margin-top:16px;color:#aaa;font-size:13px;}
    .switch a{color:var(--c2);cursor:pointer;text-decoration:underline;}
    @keyframes aura-pulse{0%{box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}50%{box-shadow:0 0 20px var(--c1),0 0 40px rgba(0,255,255,.8);}100%{box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}}
    #topBar{background:rgba(0,0,0,.7);padding:8px 16px;color:#ccc;font-size:13px;border-bottom:1px solid var(--border);text-align:center;backdrop-filter:blur(8px);display:flex;justify-content:center;align-items:center;}
    #clock{color:var(--c1);font-weight:600;}
    #playersOnline{color:var(--c1);font-weight:600;position:absolute;right:16px;}
    #tabs{display:flex;background:rgba(0,0,0,.85);border-bottom:2px solid var(--c1);backdrop-filter:blur(12px);user-select:none;}
    .tab{padding:14px 24px;cursor:pointer;font-weight:600;font-size:14px;transition:var(--transition);color:#ccc;position:relative;}
    .tab:hover{background:var(--accent);}
    .tab.active{background:var(--accent);color:var(--c1);}
    .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:2px;background:var(--c1);}
    #app{flex:1;display:flex;}
    #servers{width:72px;background:rgba(0,0,0,.8);padding:12px 0;display:flex;flex-direction:column;align-items:center;gap:12px;border-right:1px solid var(--border);}
    .srv{width:48px;height:48px;border-radius:50%;background:var(--c1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#000;box-shadow:0 0 12px rgba(0,255,255,.5);transition:var(--transition);position:relative;}
    .srv:hover{transform:scale(1.1);border-radius:35%;}
    .srv.add{background:var(--c2);font-size:28px;}
    .srv::after{content:attr(data-name);position:absolute;left:64px;top:50%;transform:translateY(-50%);background:#000;color:#fff;padding:6px 10px;border-radius:4px;font-size:12px;opacity:0;transition:var(--transition);border:1px solid var(--c1);white-space:nowrap;}
    .srv:hover::after{opacity:1;}
    #main{flex:1;display:flex;}
    #channels{width:240px;background:rgba(17,17,17,.9);padding:16px 8px;border-right:2px solid var(--c1);overflow-y:auto;backdrop-filter:blur(10px);}
    #channels h3{color:var(--c1);margin:0 8px 12px;font-size:13px;text-transform:uppercase;letter-spacing:1px;font-weight:600;}
    .chan{padding:8px 12px;margin:2px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition);font-size:14px;display:flex;justify-content:space-between;align-items:center;color:#ccc;}
    .chan:hover,.chan.active{background:var(--accent);color:var(--c1);}
    .chan .delete{color:#f55;font-size:10px;cursor:pointer;opacity:0;transition:var(--transition);}
    .chan:hover .delete{opacity:1;}
    #chatArea{flex:1;display:flex;flex-direction:column;}
    #messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    .msg{max-width:70%;padding:12px 16px;background:var(--card);border-left:4px solid var(--c1);border-radius:var(--radius);align-self:flex-start;word-wrap:break-word;box-shadow:0 1px 3px rgba(0,0,0,.2);}
    .msg.own{align-self:flex-end;background:#1a1a1a;border-left:none;border-right:4px solid var(--c2);}
    .msg strong{color:var(--c2);}
    #inputArea{display:flex;padding:16px;background:rgba(0,0,0,.9);border-top:2px solid var(--c2);gap:12px;align-items:center;backdrop-filter:blur(10px);margin-bottom:70px;position:relative;z-index:1002;}
    #msgInput{flex:1;background:var(--card);border:2px solid transparent;color:var(--text);padding:14px 18px;border-radius:12px;outline:none;font-size:16px;min-height:50px;resize:none;transition:var(--transition);}
    #msgInput:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    #sendBtn{background:var(--c1);color:#000;border:none;padding:0 24px;border-radius:12px;cursor:pointer;font-weight:bold;height:50px;min-width:80px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    #sendBtn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #dmList{padding:16px 8px;}
    .dm-user{padding:10px 12px;margin:4px 8px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;position:relative;}
    .dm-user:hover{background:var(--accent);}
    .dm-user .status-dot{width:10px;height:10px;border-radius:50%;background:var(--online);}
    .dm-user.offline .status-dot{background:#666;}
    #friendsList{padding:16px 8px;}
    .friend{padding:10px 12px;margin:4px 8px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;position:relative;}
    .friend:hover{background:var(--accent);}
    .friend .status-dot{width:10px;height:10px;border-radius:50%;background:var(--online);}
    .friend.offline .status-dot{background:#666;}
    .friend.pending{opacity:.7;}
    .friend.pending .accept-btn,.friend.pending .reject-btn{margin-left:10px;padding:2px 8px;font-size:10px;cursor:pointer;}
    .friend.pending .accept-btn{background:var(--online);color:#000;border-radius:var(--radius);}
    .friend.pending .reject-btn{background:var(--dnd);color:#000;border-radius:var(--radius);}
    #newsFeed{padding:20px;overflow-y:auto;flex:1;}
    .news-item{background:var(--card);padding:12px 16px;border-radius:var(--radius);margin-bottom:12px;border-left:4px solid var(--c1);box-shadow:0 1px 3px rgba(0,0,0,.2);}
    .news-item h4{color:var(--c1);margin-bottom:6px;font-size:16px;font-weight:600;}
    .news-item p{color:#ccc;font-size:14px;}
    #shopView{display:none;padding:20px;overflow-y:auto;flex:1;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);}
    .shop-item{background:var(--card);padding:12px 16px;border-radius:var(--radius);margin-bottom:12px;border-left:4px solid var(--c1);box-shadow:0 1px 3px rgba(0,0,0,.2);display:flex;justify-content:space-between;align-items:center;}
    .shop-item h4{color:var(--c1);margin-bottom:6px;font-size:16px;font-weight:600;}
    .shop-item p{color:#ccc;font-size:14px;}
    .shop-item .buy-btn{background:var(--c2);color:#000;padding:6px 12px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:bold;transition:var(--transition);box-shadow:0 0 10px var(--c2),0 0 20px rgba(255,0,255,.5);}
    .shop-item .buy-btn:hover{background:#e0c;box-shadow:0 0 15px var(--c2),0 0 30px rgba(255,0,255,.7);}
    .shop-item .buy-btn:disabled{background:#666;cursor:not-allowed;box-shadow:none;}
    #pointsDisplay{color:var(--c1);font-weight:600;margin-bottom:10px;}
    #gamesView{display:none;padding:20px;overflow-y:auto;flex:1;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);}
    .game-container{background:var(--card);padding:12px 16px;border-radius:var(--radius);margin-bottom:12px;border-left:4px solid var(--c1);box-shadow:0 1px 3px rgba(0,0,0,.2);text-align:center;}
    .game-container h4{color:var(--c1);margin-bottom:6px;font-size:16px;font-weight:600;}
    #gameArea{margin-top:10px;}
    #playBtn{background:var(--c1);color:#000;padding:8px 16px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:bold;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}
    #playBtn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #gameResult{color:#ccc;margin-top:10px;}
    #globalView{flex:1;flex-direction:column;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);}
    #globalHeader{padding:16px;border-bottom:1px solid var(--border);font-weight:600;color:var(--c1);}
    #globalMessages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    #globalInputArea{display:flex;padding:16px;background:rgba(0,0,0,.9);border-top:2px solid var(--c2);gap:12px;align-items:center;backdrop-filter:blur(10px);margin-bottom:70px;position:relative;z-index:1002;}
    #globalMsgInput{flex:1;background:var(--card);border:2px solid transparent;color:var(--text);padding:14px 18px;border-radius:12px;outline:none;font-size:16px;min-height:50px;resize:none;transition:var(--transition);}
    #globalMsgInput:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    #globalSendBtn{background:var(--c1);color:#000;border:none;padding:0 24px;border-radius:12px;cursor:pointer;font-weight:bold;height:50px;min-width:80px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    #globalSendBtn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #forgotPasswordModal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9998;}
    #forgotPasswordBox{background:var(--card);padding:30px;border-radius:var(--radius);width:400px;text-align:center;border:2px solid var(--c1);}
    #forgotPasswordBox h3{color:var(--c1);margin-bottom:20px;font-size:20px;font-weight:600;}
    #forgotPasswordInput{width:100%;padding:12px 16px;margin:10px 0;background:var(--accent);border:1px solid var(--c1);border-radius:var(--radius);color:var(--text);font-size:15px;outline:none;transition:var(--transition);}
    #forgotPasswordInput:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    #resetPasswordBtn{background:var(--c1);color:#000;padding:12px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;width:100%;margin-top:10px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    #resetPasswordBtn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #closeForgotModalBtn{background:#f55;color:#000;padding:10px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:bold;margin-top:10px;transition:var(--transition);box-shadow:0 0 10px #f55,0 0 20px rgba(255,85,85,.5);}
    #closeForgotModalBtn:hover{background:#f77;box-shadow:0 0 15px #f55,0 0 30px rgba(255,85,85,.7);}
    #userPanel{position:fixed;bottom:0;left:0;width:100%;background:rgba(0,0,0,.9);padding:10px 16px;display:flex;align-items:center;gap:12px;border-top:1px solid var(--border);z-index:1000;backdrop-filter:blur(10px);height:60px;}
    #userAvatar{width:36px;height:36px;border-radius:50%;border:2px solid var(--c1);object-fit:cover;}
    #userName{font-weight:600;}
    #userStatus{font-size:11px;color:var(--online);}
    #inviteModal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9998;}
    #inviteBox{background:var(--card);padding:30px;border-radius:var(--radius);width:400px;text-align:center;border:2px solid var(--c1);}
    #inviteLink{background:var(--accent);padding:12px;border-radius:var(--radius);margin:15px 0;word-break:break-all;color:var(--c1);font-weight:bold;}
    .copy-btn{background:var(--c1);color:#000;padding:10px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:bold;box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    .copy-btn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #connectionStatus{position:fixed;top:10px;right:10px;padding:8px 16px;border-radius:var(--radius);font-size:12px;font-weight:bold;z-index:1000;}
    .status-connected{background:#0f0;color:#000;}
    .status-connecting{background:#fa0;color:#000;}
    .btn-small{background:var(--c1);color:#000;padding:6px 10px;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:bold;margin:5px 8px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    .btn-small:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    .btn-small.invite{background:var(--c2);box-shadow:0 0 10px var(--c2),0 0 20px rgba(255,0,255,.5);}
    .btn-small.invite:hover{background:#e0c;box-shadow:0 0 15px var(--c2),0 0 30px rgba(255,0,255,.7);}
  </style>
</head>
<body>
  <div id="notifications"></div>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div id="loginBox">
      <h2 id="loginTitle">Sign In</h2>
      <input id="username" class="input" placeholder="Username" type="text">
      <input id="password" class="input" placeholder="Password" type="password">
      <button id="authBtn" class="btn">Sign In</button>
      <div class="switch"><span id="switchText">Don't have an account? </span><a id="switchLink">Create one</a></div>
      <div class="switch"><a id="forgotPasswordLink">Forgot Password?</a></div>
    </div>
  </div>

  <!-- TOP BAR -->
  <div id="topBar">
    <div id="clock"></div>
    <div id="playersOnline">Players: 0</div>
  </div>

  <!-- TABS -->
  <div id="tabs">
    <div class="tab active" data-tab="home">Home</div>
    <div class="tab" data-tab="dms">DMs</div>
    <div class="tab" data-tab="friends">Friends</div>
    <div class="tab" data-tab="news">News</div>
    <div class="tab" data-tab="shop">Shop</div>
    <div class="tab" data-tab="games">Games</div>
    <div class="tab" data-tab="global">Global</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- HOME (SERVER/CHANNEL) -->
  <div id="app">
    <div id="servers"></div>
    <div id="main">
      <div id="channels">
        <h3>Channels</h3>
        <div id="channelList"></div>
        <button id="addChannelBtn" class="btn-small">+ Channel</button>
        <button id="inviteBtn" class="btn-small invite">Invite</button>
      </div>
      <div id="chatArea">
        <div id="messages"></div>
        <div id="inputArea">
          <textarea id="msgInput" placeholder="Type message..."></textarea>
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL CHAT -->
  <div id="globalView" style="display:none;">
    <div id="globalHeader">Global Chat</div>
    <div id="globalMessages"></div>
    <div id="globalInputArea">
      <textarea id="globalMsgInput" placeholder="Say something to the world..."></textarea>
      <button id="globalSendBtn">Send</button>
    </div>
  </div>

  <!-- USER PANEL -->
  <div id="userPanel">
    <img id="userAvatar" src="https://i.imgur.com/6VBx3io.png" alt="avatar">
    <span id="userName"></span>
    <span id="userStatus"></span>
    <span id="userBio"></span>
  </div>

  <!-- CONNECTION STATUS -->
  <div id="connectionStatus" class="status-connecting">Connecting...</div>

  <script>
    // GLOBALS
    const socket = io(location.origin, { transports: ['websocket', 'polling'], reconnectionAttempts: 5 });
    let myName = null, currentServer = 'home', currentChannel = 'general';
    let servers = {}, onlineUsers = {}, messages = {}, points = 0;

    const els = {
      loginScreen: document.getElementById('loginScreen'),
      notifications: document.getElementById('notifications'),
      clock: document.getElementById('clock'),
      playersOnline: document.getElementById('playersOnline'),
      userAvatar: document.getElementById('userAvatar'),
      userName: document.getElementById('userName'),
      userStatus: document.getElementById('userStatus'),
      userBio: document.getElementById('userBio'),
      connectionStatus: document.getElementById('connectionStatus'),
      globalMessages: document.getElementById('globalMessages'),
      globalMsgInput: document.getElementById('globalMsgInput'),
      globalSendBtn: document.getElementById('globalSendBtn')
    };

    function showNotification(msg) {
      els.notifications.textContent = msg;
      els.notifications.style.display = 'block';
      setTimeout(() => els.notifications.style.display = 'none', 3000);
    }

    // LOGIN
    let isSignup = false;
    document.getElementById('authBtn').onclick = () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) return showNotification('Fill all fields');
      isSignup ? signup(u, p) : login(u, p);
    };
    document.getElementById('switchLink').onclick = () => {
      isSignup = !isSignup;
      document.getElementById('loginTitle').textContent = isSignup ? 'Create Account' : 'Sign In';
      document.getElementById('authBtn').textContent = isSignup ? 'Sign Up' : 'Sign In';
      document.getElementById('switchText').innerHTML = isSignup ? 'Have an account? ' : "Don't have an account? ";
      document.getElementById('switchLink').textContent = isSignup ? 'Sign In' : 'Create one';
    };

    function signup(u, p) {
      if (u.length < 3 || p.length < 4) return showNotification('Username 3+, Password 4+');
      const key = `user_${u}`;
      if (localStorage.getItem(key)) return showNotification('Username taken');
      const userData = { password: p, points: 0, servers: { home: { name: 'Home', channels: ['general'], members: [u] }}};
      localStorage.setItem(key, JSON.stringify(userData));
      showNotification('Account created!');
      login(u, p);
    }

    function login(u, p) {
      const key = `user_${u}`;
      const data = localStorage.getItem(key);
      if (!data || JSON.parse(data).password !== p) return showNotification('Wrong credentials');
      localStorage.setItem('ghostcordAccount', JSON.stringify({ username: u, password: p }));
      els.loginScreen.style.display = 'none';
      myName = u;
      initApp();
    }

    // AUTO LOGIN
    const saved = localStorage.getItem('ghostcordAccount');
    if (saved) {
      const { username, password } = JSON.parse(saved);
      login(username, password);
    }

    function initApp() {
      const userData = JSON.parse(localStorage.getItem(`user_${myName}`));
      servers = userData.servers || { home: { name: 'Home', channels: ['general'], members: [myName] }};
      points = userData.points || 0;
      messages = JSON.parse(localStorage.getItem('ghostcordMessages') || '{}');

      // SOCKET
      socket.emit('join', { name: myName });

      socket.on('connect', () => {
        els.connectionStatus.textContent = 'Connected';
        els.connectionStatus.className = 'status-connected';
      });

      socket.on('users', list => {
        onlineUsers = list;
        updatePlayers();
      });

      socket.on('userOnline', d => {
        onlineUsers[d.name] = 'online';
        updatePlayers();
      });

      socket.on('userOffline', d => {
        delete onlineUsers[d.name];
        updatePlayers();
      });

      socket.on('channelMessage', data => {
        const key = `${data.server}:${data.channel}`;
        messages[key] = messages[key] || [];
        messages[key].push(data.msg);
        saveMessages();
        if (currentServer === data.server && currentChannel === data.channel) appendMessage(data.msg);
      });

      socket.on('globalMessage', msg => {
        messages.global = messages.global || [];
        messages.global.push(msg);
        saveMessages();
        appendGlobalMessage(msg);
      });

      // UI
      renderServers();
      loadSettings();
      updateClock();
      setInterval(updateClock, 60000);
      bindEvents();
    }

    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: '2-digit', minute: '2-digit', hour12: true });
      const date = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      els.clock.textContent = `${time} CST, ${date}`;
    }

    function updatePlayers() {
      els.playersOnline.textContent = `Players: ${Object.keys(onlineUsers).length}`;
    }

    function renderServers() {
      const list = document.getElementById('servers');
      list.innerHTML = '';
      Object.entries(servers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'srv';
        div.textContent = s.name[0].toUpperCase();
        div.dataset.name = s.name;
        div.dataset.id = id;
        div.onclick = () => switchServer(id);
        if (id === currentServer) div.style.background = '#0f0';
        list.appendChild(div);
      });
      const add = document.createElement('div');
      add.className = 'srv add';
      add.textContent = '+';
      add.onclick = createServer;
      list.appendChild(add);
    }

    function createServer() {
      const name = prompt('Server name:');
      if (!name) return;
      const id = Date.now().toString();
      servers[id] = { name, channels: ['general'], members: [myName] };
      saveUserData();
      renderServers();
      switchServer(id);
    }

    function switchServer(id) {
      currentServer = id;
      const s = servers[id];
      const channelList = document.getElementById('channelList');
      channelList.innerHTML = '';
      s.channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'chan';
        div.innerHTML = `# ${ch} <span class="delete">Ã—</span>`;
        div.onclick = e => {
          if (e.target.classList.contains('delete')) return removeChannel(ch);
          document.querySelectorAll('.chan').forEach(c => c.classList.remove('active'));
          div.classList.add('active');
          currentChannel = ch;
          document.getElementById('msgInput').placeholder = `Message #${ch}...`;
          loadChannelMessages();
        };
        if (ch === 'general') div.classList.add('active');
        channelList.appendChild(div);
      });
      renderServers();
      document.getElementById('messages').innerHTML = '';
      currentChannel = 'general';
      loadChannelMessages();
    }

    function removeChannel(ch) {
      if (!confirm(`Delete #${ch}?`)) return;
      servers[currentServer].channels = servers[currentServer].channels.filter(c => c !== ch);
      saveUserData();
      switchServer(currentServer);
    }

    function loadChannelMessages() {
      const key = `${currentServer}:${currentChannel}`;
      const msgs = messages[key] || [];
      const el = document.getElementById('messages');
      el.innerHTML = '';
      msgs.forEach(m => appendMessage(m));
    }

    function appendMessage(msg) {
      const el = document.getElementById('messages');
      const own = msg.user === myName;
      const m = document.createElement('div');
      m.className = `msg ${own ? 'own' : ''}`;
      m.innerHTML = `<strong>[${msg.time}] ${msg.user}:</strong> ${msg.text}`;
      el.appendChild(m);
      el.scrollTop = el.scrollHeight;
    }

    function appendGlobalMessage(msg) {
      const m = document.createElement('div');
      m.className = `msg ${msg.user === myName ? 'own' : ''}`;
      m.innerHTML = `<strong>[${msg.time}] ${msg.user}:</strong> ${msg.text}`;
      els.globalMessages.appendChild(m);
      els.globalMessages.scrollTop = els.globalMessages.scrollHeight;
    }

    function sendChannelMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const msg = { user: myName, text, time };
      socket.emit('channelMessage', { server: currentServer, channel: currentChannel, msg });
      input.value = '';
    }

    function sendGlobalMessage() {
      const text = els.globalMsgInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      socket.emit('globalMessage', { text, time });
      els.globalMsgInput.value = '';
    }

    function loadSettings() {
      const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
      const s = data.settings || {};
      document.body.style.setProperty('--wallpaper', s.wallpaper ? `url(${s.wallpaper})` : 'none');
      els.userName.textContent = myName;
      els.userBio.textContent = s.bio || '';
      els.userStatus.textContent = s.status || 'online';
      els.userStatus.style.color = { online: 'var(--online)', idle: 'var(--idle)', dnd: 'var(--dnd)', invisible: 'var(--invisible)' }[s.status] || 'var(--online)';
      if (s.avatar) els.userAvatar.src = s.avatar;
    }

    function saveUserData() {
      const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
      data.servers = servers;
      data.points = points;
      localStorage.setItem(`user_${myName}`, JSON.stringify(data));
    }

    function saveMessages() {
      localStorage.setItem('ghostcordMessages', JSON.stringify(messages));
    }

    function bindEvents() {
      document.getElementById('addChannelBtn').onclick = () => {
        const name = prompt('Channel name:');
        if (name && !servers[currentServer].channels.includes(name)) {
          servers[currentServer].channels.push(name);
          saveUserData();
          switchServer(currentServer);
        }
      };

      document.getElementById('sendBtn').onclick = sendChannelMessage;
      document.getElementById('msgInput').onkeydown = e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChannelMessage(); }
      };

      els.globalSendBtn.onclick = sendGlobalMessage;
      els.globalMsgInput.onkeydown = e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobalMessage(); }
      };

      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('app').style.display = tab.dataset.tab === 'home' ? 'flex' : 'none';
          document.getElementById('globalView').style.display = tab.dataset.tab === 'global' ? 'flex' : 'none';
          if (tab.dataset.tab === 'global') {
            els.globalMessages.innerHTML = '';
            (messages.global || []).forEach(appendGlobalMessage);
          }
        };
      });
    }
  </script>
</body>
</html>
