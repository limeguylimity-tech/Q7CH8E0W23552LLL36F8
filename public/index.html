<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GHOSTCORD v6.6</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{--c1:#00ffff;--c2:#ff00ff;--bg:#0d0d0d;--card:#111;--accent:#1a1a1a;--text:#eee;--border:#333;--online:#00ff00;--idle:#ffaa00;--dnd:#ff5555;--invisible:#666;--radius:8px;--transition:all .2s ease;}
    [data-theme="light"]{--bg:#f5f5f5;--card:#fff;--accent:#eee;--text:#222;--border:#ddd;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
    #notifications{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--card);padding:10px 20px;border-radius:var(--radius);border:2px solid var(--c1);z-index:10000;display:none;box-shadow:0 0 10px rgba(0,255,255,.5);}
    #loginScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:9999;}
    #loginBox{background:var(--card);padding:32px;border-radius:var(--radius);width:340px;box-shadow:0 0 40px rgba(0,255,255,.3);border:2px solid var(--c1);}
    #loginBox h2{color:var(--c1);text-align:center;margin-bottom:20px;font-size:24px;font-weight:600;}
    .input{width:100%;padding:12px 16px;margin:10px 0;background:var(--accent);border:1px solid var(--c1);border-radius:var(--radius);color:var(--text);font-size:15px;outline:none;transition:var(--transition);}
    .input:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    .btn{background:var(--c1);color:#000;padding:12px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;width:100%;margin-top:10px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    .btn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    .switch{text-align:center;margin-top:16px;color:#aaa;font-size:13px;}
    .switch a{color:var(--c2);cursor:pointer;text-decoration:underline;}
    @keyframes aura-pulse{0%{box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}50%{box-shadow:0 0 20px var(--c1),0 0 40px rgba(0,255,255,.8);}100%{box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);}}
    #topBar{background:rgba(0,0,0,.7);padding:8px 16px;color:#ccc;font-size:13px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);display:flex;justify-content:space-between;align-items:center;}
    #topBarLeft,#topBarCenter,#topBarRight{display:flex;align-items:center;gap:16px;}
    #userInfo{display:flex;align-items:center;gap:10px;padding:4px 12px;background:rgba(0,255,255,.1);border-radius:20px;border:1px solid var(--c1);}
    #userAvatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--c1);object-fit:cover;}
    #userDetails{display:flex;flex-direction:column;gap:2px;}
    #userName{font-weight:600;color:var(--c1);font-size:13px;}
    #userStatus{font-size:10px;color:var(--online);}
    #clock{color:var(--c1);font-weight:600;}
    #playersOnline{color:var(--c1);font-weight:600;padding:4px 12px;background:rgba(255,0,255,.1);border-radius:20px;border:1px solid var(--c2);}
    #tabs{display:flex;background:rgba(0,0,0,.85);border-bottom:2px solid var(--c1);backdrop-filter:blur(12px);user-select:none;}
    .tab{padding:14px 24px;cursor:pointer;font-weight:600;font-size:14px;transition:var(--transition);color:#ccc;position:relative;}
    .tab:hover{background:var(--accent);}
    .tab.active{background:var(--accent);color:var(--c1);}
    .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:2px;background:var(--c1);}
    #app{flex:1;display:flex;overflow:hidden;}
    #servers{width:72px;background:rgba(0,0,0,.8);padding:12px 0;display:flex;flex-direction:column;align-items:center;gap:12px;border-right:1px solid var(--border);overflow-y:auto;}
    .srv{width:48px;height:48px;border-radius:50%;background:var(--c1);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#000;box-shadow:0 0 12px rgba(0,255,255,.5);transition:var(--transition);position:relative;flex-shrink:0;}
    .srv:hover{transform:scale(1.1);border-radius:35%;}
    .srv.add{background:var(--c2);font-size:28px;}
    .srv.active{border:3px solid #0f0;}
    .srv::after{content:attr(data-name);position:absolute;left:64px;top:50%;transform:translateY(-50%);background:#000;color:#fff;padding:6px 10px;border-radius:4px;font-size:12px;opacity:0;transition:var(--transition);border:1px solid var(--c1);white-space:nowrap;z-index:100;}
    .srv:hover::after{opacity:1;}
    #main{flex:1;display:flex;overflow:hidden;}
    #channels{width:240px;background:rgba(17,17,17,.9);padding:16px 8px;border-right:2px solid var(--c1);overflow-y:auto;backdrop-filter:blur(10px);display:flex;flex-direction:column;}
    #channels h3{color:var(--c1);margin:0 8px 12px;font-size:13px;text-transform:uppercase;letter-spacing:1px;font-weight:600;}
    #channelList{flex:1;overflow-y:auto;}
    .chan{padding:8px 12px;margin:2px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition);font-size:14px;display:flex;justify-content:space-between;align-items:center;color:#ccc;}
    .chan:hover,.chan.active{background:var(--accent);color:var(--c1);}
    .chan .delete{color:#f55;font-size:10px;cursor:pointer;opacity:0;transition:var(--transition);}
    .chan:hover .delete{opacity:1;}
    #chatArea{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden;}
    #chatHeader{padding:12px 16px;background:rgba(0,0,0,.8);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    #chatHeader h3{color:var(--c1);font-size:16px;}
    #clearChatBtn{background:#f55;color:#000;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:var(--transition);}
    #clearChatBtn:hover{background:#f77;}
    #messages,#globalMessages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    .msg{max-width:70%;padding:12px 16px;background:var(--card);border-left:4px solid var(--c1);border-radius:var(--radius);align-self:flex-start;word-wrap:break-word;box-shadow:0 1px 3px rgba(0,0,0,.2);}
    .msg.own{align-self:flex-end;background:#1a1a1a;border-left:none;border-right:4px solid var(--c2);}
    .msg strong{color:var(--c2);}
    #inputArea,#globalInputArea{position:sticky;bottom:0;background:rgba(0,0,0,.9);padding:16px;border-top:2px solid var(--c2);gap:12px;align-items:center;backdrop-filter:blur(10px);z-index:1002;display:flex;}
    #msgInput,#dmInput,#globalMsgInput{flex:1;background:var(--card);border:2px solid transparent;color:var(--text);padding:14px 18px;border-radius:12px;outline:none;font-size:16px;min-height:50px;resize:none;transition:var(--transition);}
    #msgInput:focus,#dmInput:focus,#globalMsgInput:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(0,255,255,.2);}
    #sendBtn,#dmSendBtn,#globalSendBtn{background:var(--c1);color:#000;border:none;padding:0 24px;border-radius:12px;cursor:pointer;font-weight:bold;height:50px;min-width:80px;transition:var(--transition);box-shadow:0 0 10px var(--c1),0 0 20px rgba(0,255,255,.5);animation:aura-pulse 2s infinite ease-in-out;}
    #sendBtn:hover,#dmSendBtn:hover,#globalSendBtn:hover{background:#0cc;box-shadow:0 0 15px var(--c1),0 0 30px rgba(0,255,255,.7);}
    #dmView,#friendsView,#newsView,#shopView,#gamesView,#settingsView,#globalView,#serverListView{flex:1;display:none;flex-direction:column;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);position:relative;overflow:hidden;}
    #dmHeader,#globalHeader,#serverListHeader{padding:16px;border-bottom:1px solid var(--border);font-weight:600;color:var(--c1);display:flex;justify-content:space-between;align-items:center;}
    #dmMessages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
    #friendsList,#serverList{padding:20px;overflow-y:auto;flex:1;}
    .friend,.server-item{padding:12px 16px;margin:8px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px;background:var(--card);border-left:4px solid var(--c1);transition:var(--transition);}
    .friend:hover,.server-item:hover{background:var(--accent);transform:translateX(4px);}
    .status-dot{width:10px;height:10px;border-radius:50%;background:var(--online);}
    .offline .status-dot{background:#666;}
    .accept-btn,.reject-btn{margin-left:10px;padding:2px 8px;font-size:10px;cursor:pointer;border-radius:var(--radius);}
    .accept-btn{background:var(--online);color:#000;}
    .reject-btn{background:var(--dnd);color:#000;}
    #connectionStatus{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:16px 32px;border-radius:var(--radius);font-size:14px;font-weight:bold;z-index:10001;display:none;background:#fa0;color:#000;box-shadow:0 0 20px rgba(0,0,0,.5);}
    .status-connected{background:#0f0;color:#000;}
    .btn-small{background:var(--c1);color:#000;padding:6px 10px;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:bold;margin:5px 8px;}
    #callUI{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);padding:32px;border-radius:var(--radius);border:2px solid var(--c1);box-shadow:0 0 40px rgba(0,255,255,.5);z-index:10002;min-width:300px;text-align:center;}
  </style>
</head>
<body>
  <div id="notifications"></div>
  <div id="loginScreen">
    <div id="loginBox">
      <h2 id="loginTitle">Sign In</h2>
      <input id="username" class="input" placeholder="Username" type="text" autocomplete="username">
      <input id="password" class="input" placeholder="Password" type="password" autocomplete="current-password">
      <button id="authBtn" class="btn">Sign In</button>
      <div class="switch"><span id="switchText">Don't have an account? </span><a id="switchLink">Create one</a></div>
    </div>
  </div>

  <div id="topBar">
    <div id="topBarLeft">
      <div id="userInfo">
        <img id="userAvatar" src="https://i.imgur.com/6VBx3io.png" alt="avatar">
        <div id="userDetails">
          <span id="userName"></span>
          <span id="userStatus"></span>
        </div>
      </div>
    </div>
    <div id="topBarCenter"><div id="clock"></div></div>
    <div id="topBarRight"><div id="playersOnline">Players: 0</div></div>
  </div>

  <div id="tabs">
    <div class="tab active" data-tab="home">Home</div>
    <div class="tab" data-tab="serverlist">Servers</div>
    <div class="tab" data-tab="dms">DMs</div>
    <div class="tab" data-tab="friends">Friends</div>
    <div class="tab" data-tab="news">News</div>
    <div class="tab" data-tab="shop">Shop</div>
    <div class="tab" data-tab="games">Games</div>
    <div class="tab" data-tab="global">Global</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <div id="app">
    <div id="servers"><div class="srv add" id="addServerBtn">+</div></div>
    <div id="main">
      <div id="channels">
        <h3>Channels</h3>
        <div id="channelList"></div>
        <button id="addChannelBtn" class="btn-small">+ Channel</button>
      </div>
      <div id="chatArea">
        <div id="chatHeader">
          <h3 id="chatTitle">Select a channel</h3>
          <button id="clearChatBtn">Clear Chat</button>
        </div>
        <div id="messages"></div>
        <div id="inputArea">
          <textarea id="msgInput" placeholder="Select a server..."></textarea>
          <button id="sendBtn" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <div id="serverListView"><div id="serverListHeader"><h3>All Servers</h3></div><div id="serverList"></div></div>
  <div id="dmView">
    <div id="dmHeader"><span>Select a DM</span><button id="clearDmBtn" class="btn-small" style="background:#f55;">Clear</button></div>
    <div id="dmMessages"></div>
    <div id="inputArea">
      <textarea id="dmInput" placeholder="Select a DM..."></textarea>
      <button id="dmSendBtn" disabled>Send</button>
    </div>
  </div>
  <div id="globalView">
    <div id="globalHeader"><span>Global Chat</span><button id="clearGlobalBtn" class="btn-small" style="background:#f55;">Clear</button></div>
    <div id="globalMessages"></div>
    <div id="globalInputArea">
      <textarea id="globalMsgInput" placeholder="Say something..."></textarea>
      <button id="globalSendBtn">Send</button>
    </div>
  </div>
  <div id="friendsView">
    <input id="addFriendInput" class="input" placeholder="Add friend...">
    <button id="addFriendBtn" class="btn-small">Add</button>
    <div id="friendsList"></div>
  </div>
  <div id="newsView"><div id="newsFeed"></div></div>
  <div id="shopView"><div id="pointsDisplay">Points: 0</div><div id="shopItems"></div></div>
  <div id="gamesView">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
      <div style="font-size:64px;">Wrench</div>
      <h2 style="color:var(--c1);font-size:32px;">Closed for Maintenance</h2>
      <p style="color:#aaa;font-size:16px;">Games are currently unavailable. Check back soon!</p>
    </div>
  </div>
  <div id="settingsView">
    <input id="nameInput" class="input" placeholder="Name" readonly>
    <input id="bioInput" class="input" placeholder="Bio">
    <select id="themeSelect" class="input"><option value="dark">Dark</option><option value="light">Light</option></select>
    <select id="statusSelect" class="input"><option value="online">Online</option><option value="idle">Idle</option><option value="dnd">DND</option><option value="invisible">Invisible</option></select>
    <button id="saveSettingsBtn" class="btn">Save Settings</button>
    <button id="logoutBtn" class="btn">Logout</button>
    <div style="margin-top:30px;padding-top:30px;border-top:2px solid var(--border);">
      <h3 style="color:#f55;margin-bottom:10px;">Danger Zone</h3>
      <button id="deleteAccountBtn" class="btn" style="background:#f55;">Delete Account</button>
    </div>
  </div>

  <div id="connectionStatus" class="status-connecting">Connecting...</div>

  <div id="callUI">
    <div id="callStatus" style="color:var(--c1);font-size:18px;font-weight:600;margin-bottom:20px;">Calling...</div>
    <div id="callUser" style="color:var(--text);font-size:16px;margin-bottom:20px;"></div>
    <div id="callTimer" style="color:#aaa;font-size:14px;margin-bottom:20px;display:none;">00:00</div>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button id="acceptCallBtn" class="btn" style="background:var(--online);display:none;">Accept</button>
      <button id="endCallBtn" class="btn" style="background:#f55;">End Call</button>
    </div>
  </div>

  <script>
    let socket = null;
    let myName = null, currentServer = null, currentChannel = null, currentDM = null;
    let servers = {}, onlineUsers = {}, friends = {}, points = 0, allServers = {};
    let userData = {};

    // WebRTC
    let peerConnection = null;
    let localStream = null;
    let remoteAudio = null;
    let currentCall = null;
    let callTimer = null;
    let callStartTime = null;

    const iceConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
      ]
    };

    const els = {
      loginScreen: document.getElementById('loginScreen'),
      notifications: document.getElementById('notifications'),
      clock: document.getElementById('clock'),
      playersOnline: document.getElementById('playersOnline'),
      userName: document.getElementById('userName'),
      userStatus: document.getElementById('userStatus'),
      connectionStatus: document.getElementById('connectionStatus'),
      globalMessages: document.getElementById('globalMessages'),
      globalMsgInput: document.getElementById('globalMsgInput'),
      globalSendBtn: document.getElementById('globalSendBtn'),
      chatTitle: document.getElementById('chatTitle'),
      clearChatBtn: document.getElementById('clearChatBtn'),
      clearDmBtn: document.getElementById('clearDmBtn'),
      clearGlobalBtn: document.getElementById('clearGlobalBtn')
    };

    function show(msg) {
      els.notifications.textContent = msg;
      els.notifications.style.display = 'block';
      setTimeout(() => els.notifications.style.display = 'none', 3000);
    }

    let isSignup = false;
    document.getElementById('authBtn').onclick = () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) return show('Fill all fields');
      isSignup ? signup(u, p) : login(u, p);
    };

    document.getElementById('switchLink').onclick = () => {
      isSignup = !isSignup;
      document.getElementById('loginTitle').textContent = isSignup ? 'Create Account' : 'Sign In';
      document.getElementById('authBtn').textContent = isSignup ? 'Sign Up' : 'Sign In';
    };

    async function signup(u, p) {
      if (u.length < 3 || p.length < 4) return show('Username 3+, Password 4+');
      try {
        const res = await fetch('/api/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
        const data = await res.json();
        if (data.error) return show(data.error);
        show('Account created!');
        setTimeout(() => login(u, p), 1000);
      } catch { show('Connection error'); }
    }

    async function login(u, p) {
      try {
        const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
        const data = await res.json();
        if (data.error) return show(data.error);
        userData = data.user;
        myName = u;
        els.loginScreen.style.display = 'none';
        socket = io(location.origin, { transports: ['websocket', 'polling'] });
        initApp();
      } catch { show('Connection error'); }
    }

    function initApp() {
      points = userData.points || 0;
      els.connectionStatus.style.display = 'block';

      socket.on('connect', () => {
        els.connectionStatus.textContent = 'Connected';
        els.connectionStatus.className = 'status-connected';
        setTimeout(() => els.connectionStatus.style.display = 'none', 2000);
        socket.emit('join', { name: myName });
      });

      socket.on('connect_error', () => {
        els.connectionStatus.textContent = 'Connection Failed';
        els.connectionStatus.style.background = '#f55';
      });

      socket.on('userData', d => { servers = d.servers || {}; friends = d.friends || {}; renderServers(); updateFriendsList(); });
      socket.on('users', list => { onlineUsers = list; updatePlayers(); updateFriendsList(); });
      socket.on('userOnline', d => { onlineUsers[d.name] = 'online'; updatePlayers(); updateFriendsList(); });
      socket.on('userOffline', d => { delete onlineUsers[d.name]; updatePlayers(); updateFriendsList(); });
      socket.on('allServers', d => { allServers = d; if (document.getElementById('serverListView').style.display !== 'none') renderServerList(); });
      socket.on('serverCreated', d => { servers[d.serverId] = d.server; renderServers(); });
      socket.on('channelMessage', d => { if (currentServer === d.server && currentChannel === d.channel) appendMessage(d.msg, document.getElementById('messages')); });
      socket.on('messageHistory', d => { if (currentServer === d.server && currentChannel === d.channel) { const c = document.getElementById('messages'); c.innerHTML = ''; d.messages.forEach(m => appendMessage(m, c)); } });
      socket.on('globalMessage', m => { if (document.getElementById('globalView').style.display !== 'none') appendMessage(m, els.globalMessages); });
      socket.on('friendRequest', d => { if (d.from !== myName) { friends[d.from] = 'pending'; updateFriendsList(); show(`Friend request from ${d.from}`); } });
      socket.on('friendRequestSent', d => { friends[d.to] = 'sent'; updateFriendsList(); });
      socket.on('friendError', d => show(d.message));
      socket.on('dm', d => { if (currentDM === d.from) appendMessage(d.msg, document.getElementById('dmMessages')); });
      socket.on('acceptFriend', d => { friends[d.from] = 'accepted'; updateFriendsList(); show(`${d.from} accepted!`); });
      socket.on('friendAccepted', d => { friends[d.friend] = 'accepted'; updateFriendsList(); });
      socket.on('friendRemoved', d => { delete friends[d.from]; updateFriendsList(); });
      socket.on('friendRemovedConfirm', d => { delete friends[d.username]; updateFriendsList(); show(`Removed ${d.username}`); });

      // WebRTC Events
      socket.on('incomingCall', async ({ from, offer }) => {
        currentCall = from;
        document.getElementById('callUser').textContent = from;
        document.getElementById('callStatus').textContent = 'Incoming Call';
        document.getElementById('acceptCallBtn').style.display = 'block';
        document.getElementById('callTimer').style.display = 'none';
        document.getElementById('callUI').style.display = 'block';
        show(`Incoming call from ${from}`);
        await setupPeerConnection();
        await peerConnection.setRemoteDescription(offer);
      });

      socket.on('callAnswered', async ({ from, answer }) => {
        if (peerConnection) await peerConnection.setRemoteDescription(answer);
      });

      socket.on('iceCandidate', async ({ candidate }) => {
        if (peerConnection) {
          try { await peerConnection.addIceCandidate(candidate); } catch (e) {}
        }
      });

      socket.on('callEnded', () => endCall(false));

      loadSettings();
      updateClock();
      setInterval(updateClock, 60000);
      bindEvents();
      showTab('home');
    }

    async function setupPeerConnection() {
      if (peerConnection) peerConnection.close();
      peerConnection = new RTCPeerConnection(iceConfig);
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

      peerConnection.ontrack = e => {
        if (!remoteAudio) {
          remoteAudio = new Audio();
          remoteAudio.autoplay = true;
          document.body.appendChild(remoteAudio);
        }
        remoteAudio.srcObject = e.streams[0];
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate && currentCall) socket.emit('iceCandidate', { to: currentCall, candidate: e.candidate });
      };

      peerConnection.oniceconnectionstatechange = () => {
        if (peerConnection.iceConnectionState === 'connected' || peerConnection.iceConnectionState === 'completed') {
          document.getElementById('callStatus').textContent = 'Connected';
          document.getElementById('callTimer').style.display = 'block';
          startCallTimer();
          show('Call Connected!');
        }
        if (peerConnection.iceConnectionState === 'failed') endCall(true);
      };
    }

    async function startCall(user) {
      if (!onlineUsers[user]) return show(`${user} is offline`);
      currentCall = user;
      document.getElementById('callUser').textContent = user;
      document.getElementById('callStatus').textContent = 'Calling...';
      document.getElementById('acceptCallBtn').style.display = 'none';
      document.getElementById('callTimer').style.display = 'none';
      document.getElementById('callUI').style.display = 'block';

      await setupPeerConnection();
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('callUser', { to: user, offer: peerConnection.localDescription });
    }

    async function acceptCall() {
      document.getElementById('acceptCallBtn').style.display = 'none';
      document.getElementById('callStatus').textContent = 'Connecting...';
      await setupPeerConnection();
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit('answerCall', { to: currentCall, answer: peerConnection.localDescription });
    }

    function endCall(notify = true) {
      if (notify && currentCall) socket.emit('endCall', { to: currentCall });
      if (peerConnection) { peerConnection.close(); peerConnection = null; }
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      if (remoteAudio) { remoteAudio.srcObject = null; remoteAudio.remove(); remoteAudio = null; }
      if (callTimer) { clearInterval(callTimer); callTimer = null; }
      document.getElementById('callUI').style.display = 'none';
      currentCall = null;
    }

    function startCallTimer() {
      callStartTime = Date.now();
      callTimer = setInterval(() => {
        const s = Math.floor((Date.now() - callStartTime) / 1000);
        const m = String(Math.floor(s / 60)).padStart(2, '0');
        const sec = String(s % 60).padStart(2, '0');
        document.getElementById('callTimer').textContent = `${m}:${sec}`;
      }, 1000);
    }

    function updateClock() {
      const now = new Date();
      els.clock.textContent = `${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })} CST, ${now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
    }

    function updatePlayers() { els.playersOnline.textContent = `Players: ${Object.keys(onlineUsers).length}`; }

    function renderServers() {
      const list = document.getElementById('servers');
      list.innerHTML = '<div class="srv add" id="addServerBtn">+</div>';
      Object.entries(servers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'srv'; if (id === currentServer) div.classList.add('active');
        div.textContent = s.name[0].toUpperCase();
        div.dataset.id = id; div.dataset.name = s.name;
        div.onclick = () => switchServer(id);
        list.appendChild(div);
      });
      document.getElementById('addServerBtn').onclick = createServer;
    }

    function renderServerList() {
      const list = document.getElementById('serverList');
      list.innerHTML = '';
      Object.entries(allServers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'server-item';
        const joined = !!servers[id];
        div.innerHTML = `<h4>${s.name}</h4><p>Owner: ${s.owner}</p><p>Channels: ${s.channels.length}</p><p>Members: ${s.members.length}</p><div class="server-actions">${joined ? '<span style="color:var(--online);">Joined</span>' : `<button class="join-btn" onclick="joinServer('${id}')">Join</button>`}</div>`;
        list.appendChild(div);
      });
    }

    window.joinServer = id => {
      socket.emit('joinServer', { serverId: id, username: myName });
      servers[id] = allServers[id];
      renderServers(); renderServerList();
      show(`Joined ${allServers[id].name}!`);
    };

    function createServer() {
      const name = prompt('Server name:');
      if (!name) return;
      const id = Date.now().toString();
      socket.emit('createServer', { serverId: id, server: { name, owner: myName, channels: ['general'], members: [myName] } });
    }

    function switchServer(id) {
      currentServer = id; currentChannel = null;
      const s = servers[id];
      const cl = document.getElementById('channelList');
      cl.innerHTML = '';
      s.channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'chan';
        div.innerHTML = `# ${ch} <span class="delete">Ã—</span>`;
        div.onclick = e => {
          if (e.target.classList.contains('delete')) { removeChannel(ch); return; }
          document.querySelectorAll('.chan').forEach(c => c.classList.remove('active'));
          div.classList.add('active');
          currentChannel = ch;
          els.chatTitle.textContent = `#${ch}`;
          document.getElementById('msgInput').placeholder = `Message #${ch}...`;
          document.getElementById('sendBtn').disabled = false;
          loadChannelMessages();
        };
        if (ch === 'general') { div.click(); }
        cl.appendChild(div);
      });
      renderServers();
      document.getElementById('messages').innerHTML = '';
    }

    function loadChannelMessages() {
      socket.emit('getMessages', { server: currentServer, channel: currentChannel });
    }

    function removeChannel(ch) {
      if (confirm(`Delete #${ch}?`)) {
        servers[currentServer].channels = servers[currentServer].channels.filter(c => c !== ch);
        switchServer(currentServer);
      }
    }

    function appendMessage(msg, container) {
      const own = msg.user === myName;
      const m = document.createElement('div');
      m.className = `msg ${own ? 'own' : ''}`;
      m.innerHTML = `<strong>[${msg.time}] ${msg.user}:</strong> ${msg.text}`;
      container.appendChild(m);
      container.scrollTop = container.scrollHeight;
    }

    function clearChat() {
      if (confirm('Clear chat display?')) {
        if (document.getElementById('globalView').style.display !== 'none') els.globalMessages.innerHTML = '';
        else if (document.getElementById('dmView').style.display !== 'none') document.getElementById('dmMessages').innerHTML = '';
        else document.getElementById('messages').innerHTML = '';
        show('Display cleared!');
      }
    }

    function sendChannel() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentChannel) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      socket.emit('channelMessage', { server: currentServer, channel: currentChannel, msg: { user: myName, text, time } });
      input.value = '';
    }

    function sendDM() {
      const input = document.getElementById('dmInput');
      const text = input.value.trim();
      if (!text || !currentDM) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      appendMessage({ user: myName, text, time }, document.getElementById('dmMessages'));
      socket.emit('dm', { to: currentDM, msg: { user: myName, text, time } });
      input.value = '';
    }

    function sendGlobal() {
      const text = els.globalMsgInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      socket.emit('globalMessage', { text, time });
      els.globalMsgInput.value = '';
    }

    function updateFriendsList() {
      const list = document.getElementById('friendsList');
      list.innerHTML = '';
      Object.entries(friends).forEach(([name, status]) => {
        const div = document.createElement('div');
        const isOnline = !!onlineUsers[name];
        div.innerHTML = `<div class="status-dot" style="background:${isOnline ? 'var(--online)' : '#666'}"></div><span>${name}</span>`;
        if (status === 'pending') {
          div.innerHTML += '<button class="accept-btn">Accept</button><button class="reject-btn">Reject</button>';
          div.querySelector('.accept-btn').onclick = () => { friends[name] = 'accepted'; updateFriendsList(); socket.emit('acceptFriend', { to: name }); };
          div.querySelector('.reject-btn').onclick = () => socket.emit('removeFriend', { username: name });
        } else if (status === 'sent') {
          div.innerHTML += '<span style="color:#aaa;margin-left:10px">(Sent)</span><button class="reject-btn">Cancel</button>';
          div.querySelector('.reject-btn').onclick = () => socket.emit('removeFriend', { username: name });
        } else if (status === 'accepted') {
          div.onclick = () => openDM(name);
          div.innerHTML += '<button class="accept-btn">Call</button><button class="reject-btn">Remove</button>';
          div.querySelector('.accept-btn').onclick = e => { e.stopPropagation(); startCall(name); };
          div.querySelector('.reject-btn').onclick = e => { e.stopPropagation(); if (confirm(`Remove ${name}?`)) socket.emit('removeFriend', { username: name }); };
        }
        list.appendChild(div);
      });
    }

    function addFriend() {
      const name = document.getElementById('addFriendInput').value.trim();
      if (!name || name === myName) return show('Invalid');
      socket.emit('friendRequest', { to: name });
      document.getElementById('addFriendInput').value = '';
    }

    function openDM(user) {
      currentDM = user;
      showTab('dms');
      document.querySelector('#dmHeader span').textContent = `@${user}`;
      document.getElementById('dmMessages').innerHTML = '';
      document.getElementById('dmInput').placeholder = `Message @${user}...`;
      document.getElementById('dmSendBtn').disabled = false;
    }

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('app').style.display = tab === 'home' ? 'flex' : 'none';
      ['serverListView','dmView','friendsView','newsView','shopView','gamesView','globalView','settingsView'].forEach(id => {
        document.getElementById(id).style.display = id === tab + 'View' || (tab === 'serverlist' && id === 'serverListView') ? 'flex' : 'none';
      });
      if (tab === 'serverlist') socket.emit('getServers');
    }

    function loadSettings() {
      document.body.dataset.theme = userData.theme || 'dark';
      els.userName.textContent = myName;
      els.userStatus.textContent = userData.status || 'online';
      els.userStatus.style.color = { online: 'var(--online)', idle: 'var(--idle)', dnd: 'var(--dnd)', invisible: 'var(--invisible)' }[userData.status] || 'var(--online)';
    }

    function bindEvents() {
      document.getElementById('addChannelBtn').onclick = () => {
        const name = prompt('Channel name:');
        if (name && currentServer) {
          servers[currentServer].channels.push(name);
          switchServer(currentServer);
        }
      };
      document.getElementById('sendBtn').onclick = sendChannel;
      document.getElementById('msgInput').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChannel(); } };
      document.getElementById('dmSendBtn').onclick = sendDM;
      document.getElementById('dmInput').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDM(); } };
      els.globalSendBtn.onclick = sendGlobal;
      els.globalMsgInput.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobal(); } };
      document.getElementById('addFriendBtn').onclick = addFriend;
      document.querySelectorAll('.tab').forEach(t => t.onclick = () => showTab(t.dataset.tab));
      document.getElementById('acceptCallBtn').onclick = acceptCall;
      document.getElementById('endCallBtn').onclick = () => endCall(true);
      els.clearChatBtn.onclick = clearChat;
      els.clearDmBtn.onclick = clearChat;
      els.clearGlobalBtn.onclick = clearChat;
    }
  </script>
</body>
</html>
