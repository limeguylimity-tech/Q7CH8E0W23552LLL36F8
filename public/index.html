<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GHOSTCORD v6.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    :root {
      --c1: #00ffff; --c2: #ff00ff; --bg: #0d0d0d; --card: #111; --accent: #1a1a1a; --text: #eee; --border: #333;
      --online: #00ff00; --idle: #ffaa00; --dnd: #ff5555; --invisible: #666;
      --radius: 8px; --transition: all 0.2s ease;
    }
    [data-theme="light"] {
      --bg: #f5f5f5; --card: #fff; --accent: #eee; --text: #222; --border: #ddd;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:var(--bg); color:var(--text);
      font-family:'Inter',sans-serif;
      display:flex; flex-direction:column; height:100vh; overflow:hidden;
      background-image: var(--wallpaper, none);
      background-size: cover; background-position: center;
    }
    /* === NOTIFICATIONS === */
    #notifications {
      position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
      background: var(--card); padding: 10px 20px; border-radius: var(--radius);
      border: 2px solid var(--c1); z-index: 10000; display: none;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    /* === LOGIN === */
    #loginScreen {
      position:fixed; inset:0; background:rgba(0,0,0,0.95);
      display:flex; align-items:center; justify-content:center; z-index:9999;
      pointer-events: auto;
    }
    #loginBox {
      background:var(--card); padding:32px; border-radius:var(--radius);
      width:340px; box-shadow:0 0 40px rgba(0,255,255,.3); border:2px solid var(--c1);
      z-index:10000; pointer-events: auto;
    }
    #loginBox h2 { color:var(--c1); text-align:center; margin-bottom:20px; font-size:24px; font-weight:600; }
    .input {
      width:100%; padding:12px 16px; margin:10px 0; background:var(--accent);
      border:1px solid var(--c1); border-radius:var(--radius); color:var(--text);
      font-size:15px; outline:none; transition:var(--transition);
      pointer-events: auto; z-index:10001;
    }
    .input:focus { border-color:var(--c1); box-shadow:0 0 0 3px rgba(0,255,255,.2); }
    .btn {
      background:var(--c1); color:#000; padding:12px; border:none; border-radius:var(--radius);
      cursor:pointer; font-weight:600; width:100%; margin-top:10px; transition:var(--transition);
      position: relative; z-index:10002; pointer-events: auto;
      box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5);
      animation: aura-pulse 2s infinite ease-in-out;
    }
    .btn:hover { background:#0cc; box-shadow: 0 0 15px var(--c1), 0 0 30px rgba(0,255,255,0.7); }
    .switch { text-align:center; margin-top:16px; color:#aaa; font-size:13px; }
    .switch a { color:var(--c2); cursor:pointer; text-decoration:underline; z-index:10002; pointer-events: auto; }
    /* === Aura Animation === */
    @keyframes aura-pulse {
      0% { box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5); }
      50% { box-shadow: 0 0 20px var(--c1), 0 0 40px rgba(0,255,255,0.8); }
      100% { box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5); }
    }
    /* === TOP BAR === */
    #topBar {
      background:rgba(0,0,0,0.7); padding:8px 16px; color:#ccc; font-size:13px;
      border-bottom:1px solid var(--border); text-align:center; backdrop-filter:blur(8px);
      z-index:1000; display: flex; justify-content: center; align-items: center;
    }
    #clock { color:var(--c1); font-weight:600; }
    #playersOnline { color: var(--c1); font-weight: 600; position: absolute; right: 16px; }
    /* === TABS === */
    #tabs {
      display:flex; background:rgba(0,0,0,0.85); border-bottom:2px solid var(--c1);
      backdrop-filter:blur(12px); user-select:none;
      z-index:1001; pointer-events: auto;
    }
    .tab {
      padding:14px 24px; cursor:pointer; font-weight:600; font-size:14px;
      transition:var(--transition); color:#ccc;
      pointer-events: auto; position: relative;
    }
    .tab:hover { background:var(--accent); }
    .tab.active { background:var(--accent); color:var(--c1); }
    .tab.active::after {
      content:''; position:absolute; bottom:-2px; left:0; width:100%; height:2px; background:var(--c1);
    }
    /* === LAYOUT === */
    #app { flex:1; display:flex; }
    #servers {
      width:72px; background:rgba(0,0,0,0.8); padding:12px 0;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      border-right:1px solid var(--border);
    }
    .srv {
      width:48px; height:48px; border-radius:50%; background:var(--c1);
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-weight:bold; color:#000; box-shadow:0 0 12px rgba(0,255,255,.5);
      transition:var(--transition); position:relative;
      pointer-events: auto;
    }
    .srv:hover { transform:scale(1.1); border-radius:35%; }
    .srv.add { background:var(--c2); font-size:28px; }
    .srv::after {
      content:attr(data-name); position:absolute; left:64px; top:50%;
      transform:translateY(-50%); background:#000; color:#fff; padding:6px 10px;
      border-radius:4px; font-size:12px; opacity:0; pointer-events:none;
      transition:var(--transition); border:1px solid var(--c1); white-space:nowrap;
    }
    .srv:hover::after { opacity:1; }
    #main { flex:1; display:flex; }
    #channels {
      width:240px; background:rgba(17,17,17,0.9); padding:16px 8px;
      border-right:2px solid var(--c1); overflow-y:auto; backdrop-filter:blur(10px);
    }
    #channels h3 {
      color:var(--c1); margin:0 8px 12px; font-size:13px; text-transform:uppercase;
      letter-spacing:1px; font-weight:600;
    }
    .chan {
      padding:8px 12px; margin:2px 8px; border-radius:var(--radius); cursor:pointer;
      transition:var(--transition); font-size:14px; display:flex;
      justify-content:space-between; align-items:center; color:#ccc;
      pointer-events: auto;
    }
    .chan:hover, .chan.active { background:var(--accent); color:var(--c1); }
    .chan .delete {
      color:#f55; font-size:10px; cursor:pointer; opacity:0; transition:var(--transition);
    }
    .chan:hover .delete { opacity:1; }
    /* === CHAT === */
    #chatArea { flex:1; display:flex; flex-direction:column; }
    #messages {
      flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:12px;
    }
    .msg {
      max-width:70%; padding:12px 16px; background:var(--card);
      border-left:4px solid var(--c1); border-radius:var(--radius);
      align-self:flex-start; word-wrap:break-word; box-shadow:0 1px 3px rgba(0,0,0,.2);
    }
    .msg.own {
      align-self:flex-end; background:#1a1a1a; border-left:none; border-right:4px solid var(--c2);
    }
    .msg strong { color:var(--c2); }
    #inputArea {
      display:flex; padding:16px; background:rgba(0,0,0,0.9);
      border-top:2px solid var(--c2); gap:12px; align-items:center; backdrop-filter:blur(10px);
      margin-bottom:70px; position: relative; z-index:1002;
    }
    #msgInput {
      flex:1; background:var(--card); border:2px solid transparent;
      color:var(--text); padding:14px 18px; border-radius:12px; outline:none;
      font-size:16px; min-height:50px; resize:none; transition:var(--transition);
      pointer-events: auto; z-index:10003;
    }
    #msgInput:focus { border-color:var(--c1); box-shadow:0 0 0 3px rgba(0,255,255,.2); }
    #sendBtn {
      background:var(--c1); color:#000; border:none; padding:0 24px;
      border-radius:12px; cursor:pointer; font-weight:bold; height:50px;
      min-width:80px; transition:var(--transition);
      pointer-events: auto; position: relative; z-index:10003;
      box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5);
      animation: aura-pulse 2s infinite ease-in-out;
    }
    #sendBtn:hover { background:#0cc; box-shadow: 0 0 15px var(--c1), 0 0 30px rgba(0,255,255,0.7); }
    /* === DM LIST === */
    #dmList { padding:16px 8px; }
    .dm-user {
      padding:10px 12px; margin:4px 8px; border-radius:var(--radius); cursor:pointer;
      display:flex; align-items:center; gap:10px; font-size:14px; position:relative;
      pointer-events: auto;
    }
    .dm-user:hover { background:var(--accent); }
    .dm-user .status-dot {
      width:10px; height:10px; border-radius:50%; background:var(--online);
    }
    .dm-user.offline .status-dot { background:#666; }
    /* === FRIENDS LIST === */
    #friendsList { padding:16px 8px; }
    .friend {
      padding:10px 12px; margin:4px 8px; border-radius:var(--radius); cursor:pointer;
      display:flex; align-items:center; gap:10px; font-size:14px; position:relative;
      pointer-events: auto;
    }
    .friend:hover { background:var(--accent); }
    .friend .status-dot {
      width:10px; height:10px; border-radius:50%; background:var(--online);
    }
    .friend.offline .status-dot { background:#666; }
    .friend.pending { opacity: 0.7; }
    .friend.pending .accept-btn, .friend.pending .reject-btn {
      margin-left: 10px; padding: 2px 8px; font-size: 10px; cursor: pointer;
    }
    .friend.pending .accept-btn { background: var(--online); color: #000; border-radius: var(--radius); }
    .friend.pending .reject-btn { background: var(--dnd); color: #000; border-radius: var(--radius); }
    /* === NEWS FEED === */
    #newsFeed { padding:20px; overflow-y:auto; flex:1; }
    .news-item {
      background:var(--card); padding:12px 16px; border-radius:var(--radius);
      margin-bottom:12px; border-left:4px solid var(--c1); box-shadow:0 1px 3px rgba(0,0,0,.2);
    }
    .news-item h4 { color:var(--c1); margin-bottom:6px; font-size:16px; font-weight:600; }
    .news-item p { color:#ccc; font-size:14px; }
    /* === SHOP VIEW === */
    #shopView {
      display:none; padding:20px; overflow-y:auto; flex:1;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
    }
    .shop-item {
      background:var(--card); padding:12px 16px; border-radius:var(--radius);
      margin-bottom:12px; border-left:4px solid var(--c1); box-shadow:0 1px 3px rgba(0,0,0,.2);
      display: flex; justify-content: space-between; align-items: center;
    }
    .shop-item h4 { color:var(--c1); margin-bottom:6px; font-size:16px; font-weight:600; }
    .shop-item p { color:#ccc; font-size:14px; }
    .shop-item .buy-btn {
      background:var(--c2); color:#000; padding:6px 12px; border:none;
      border-radius:var(--radius); cursor:pointer; font-weight:bold;
      transition:var(--transition); box-shadow:0 0 10px var(--c2), 0 0 20px rgba(255,0,255,0.5);
    }
    .shop-item .buy-btn:hover { background:#e0c; box-shadow:0 0 15px var(--c2), 0 0 30px rgba(255,0,255,0.7); }
    .shop-item .buy-btn:disabled { background:#666; cursor:not-allowed; box-shadow:none; }
    #pointsDisplay { color:var(--c1); font-weight:600; margin-bottom:10px; }
    /* === GAMES VIEW === */
    #gamesView {
      display:none; padding:20px; overflow-y:auto; flex:1;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
    }
    .game-container {
      background:var(--card); padding:12px 16px; border-radius:var(--radius);
      margin-bottom:12px; border-left:4px solid var(--c1); box-shadow:0 1px 3px rgba(0,0,0,.2);
      text-align: center;
    }
    .game-container h4 { color:var(--c1); margin-bottom:6px; font-size:16px; font-weight:600; }
    #gameArea { margin-top:10px; }
    #playBtn { 
      background:var(--c1); color:#000; padding:8px 16px; border:none;
      border-radius:var(--radius); cursor:pointer; font-weight:bold;
      transition:var(--transition); box-shadow:0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5);
    }
    #playBtn:hover { background:#0cc; box-shadow:0 0 15px var(--c1), 0 0 30px rgba(0,255,255,0.7); }
    #gameResult { color:#ccc; margin-top:10px; }
    /* === FORGOT PASSWORD MODAL === */
    #forgotPasswordModal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      display: none; align-items: center; justify-content: center; z-index: 9998;
      pointer-events: auto;
    }
    #forgotPasswordBox {
      background: var(--card); padding: 30px; border-radius: var(--radius);
      width: 400px; text-align: center; border: 2px solid var(--c1);
      z-index: 9999; pointer-events: auto;
    }
    #forgotPasswordBox h3 { color: var(--c1); margin-bottom: 20px; font-size: 20px; font-weight: 600; }
    #forgotPasswordInput { width: 100%; padding: 12px 16px; margin: 10px 0; background: var(--accent);
      border: 1px solid var(--c1); border-radius: var(--radius); color: var(--text); font-size: 15px;
      outline: none; transition: var(--transition); pointer-events: auto; }
    #forgotPasswordInput:focus { border-color: var(--c1); box-shadow: 0 0 0 3px rgba(0,255,255,.2); }
    #resetPasswordBtn { background: var(--c1); color: #000; padding: 12px; border: none;
      border-radius: var(--radius); cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px;
      transition: var(--transition); position: relative; z-index: 10000; pointer-events: auto;
      box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5);
      animation: aura-pulse 2s infinite ease-in-out; }
    #resetPasswordBtn:hover { background: #0cc; box-shadow: 0 0 15px var(--c1), 0 0 30px rgba(0,255,255,0.7); }
    #closeForgotModalBtn { background: #f55; color: #000; padding: 10px 20px; border: none;
      border-radius: var(--radius); cursor: pointer; font-weight: bold; margin-top: 10px;
      transition: var(--transition); position: relative; z-index: 10000; pointer-events: auto;
      box-shadow: 0 0 10px #f55, 0 0 20px rgba(255,85,85,0.5); }
    #closeForgotModalBtn:hover { background: #f77; box-shadow: 0 0 15px #f55, 0 0 30px rgba(255,85,85,0.7); }
    /* === USER PANEL === */
    #userPanel {
      position:fixed; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.9);
      padding:10px 16px; display:flex; align-items:center; gap:12px;
      border-top:1px solid var(--border); z-index:1000;
      backdrop-filter:blur(10px); pointer-events: auto;
      height:60px;
    }
    #userAvatar {
      width:36px; height:36px; border-radius:50%; border:2px solid var(--c1); object-fit:cover;
    }
    #userName { font-weight:600; }
    #userStatus { font-size:11px; color:var(--online); }
    /* === INVITE MODAL === */
    #inviteModal {
      position:fixed; inset:0; background:rgba(0,0,0,0.9);
      display:none; align-items:center; justify-content:center; z-index:9998;
      pointer-events: auto;
    }
    #inviteBox {
      background:var(--card); padding:30px; border-radius:var(--radius);
      width:400px; text-align:center; border:2px solid var(--c1);
      z-index:9999; pointer-events: auto;
    }
    #inviteLink {
      background:var(--accent); padding:12px; border-radius:var(--radius);
      margin:15px 0; word-break:break-all; color:var(--c1); font-weight:bold;
    }
    .copy-btn {
      background:var(--c1); color:#000; padding:10px 20px; border:none;
      border-radius:var(--radius); cursor:pointer; font-weight:bold;
      position: relative; z-index:10000; pointer-events: auto;
      box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5);
      animation: aura-pulse 2s infinite ease-in-out;
    }
    .copy-btn:hover { background:#0cc; box-shadow: 0 0 15px var(--c1), 0 0 30px rgba(0,255,255,0.7); }
    /* === STATUS === */
    #connectionStatus {
      position:fixed; top:10px; right:10px; padding:8px 16px;
      border-radius:var(--radius); font-size:12px; font-weight:bold; z-index:1000;
    }
    .status-connected { background:#0f0; color:#000; }
    .status-connecting { background:#fa0; color:#000; }
    /* === BUTTONS === */
    .btn-small {
      background:var(--c1); color:#000; padding:6px 10px; border:none;
      border-radius:var(--radius); cursor:pointer; font-size:12px;
      font-weight:bold; margin:5px 8px; transition:var(--transition);
      position: relative; z-index:10000; pointer-events: auto;
      box-shadow: 0 0 10px var(--c1), 0 0 20px rgba(0,255,255,0.5);
      animation: aura-pulse 2s infinite ease-in-out;
    }
    .btn-small:hover { background:#0cc; box-shadow: 0 0 15px var(--c1), 0 0 30px rgba(0,255,255,0.7); }
    .btn-small.invite { background:var(--c2); box-shadow: 0 0 10px var(--c2), 0 0 20px rgba(255,0,255,0.5); }
    .btn-small.invite:hover { background:#e0c; box-shadow: 0 0 15px var(--c2), 0 0 30px rgba(255,0,255,0.7); }
  </style>
</head>
<body data-theme="dark">
  <!-- NOTIFICATIONS -->
  <div id="notifications"></div>
  <!-- LOGIN -->
  <div id="loginScreen">
    <div id="loginBox">
      <h2 id="loginTitle">Sign In</h2>
      <input type="text" id="username" class="input" placeholder="Username" />
      <input type="password" id="password" class="input" placeholder="Password" />
      <button id="authBtn" class="btn">Sign In</button>
      <div class="switch">
        <span id="switchText">Don't have an account? </span>
        <a id="switchLink">Create one</a>
      </div>
      <div class="switch" style="margin-top: 8px;">
        <a id="forgotPasswordLink">Forgot Password?</a>
      </div>
    </div>
  </div>
  <!-- FORGOT PASSWORD MODAL -->
  <div id="forgotPasswordModal">
    <div id="forgotPasswordBox">
      <h3>Reset Password</h3>
      <input type="text" id="forgotPasswordInput" class="input" placeholder="Enter your username" />
      <button id="resetPasswordBtn" class="btn">Reset Password</button>
      <button id="closeForgotModalBtn" class="btn">Close</button>
    </div>
  </div>
  <!-- TOP BAR -->
  <div id="topBar">
    <span id="clock"></span> | Country: <strong>CA</strong>
    <span id="playersOnline">Players: 0</span>
  </div>
  <div id="connectionStatus" class="status-connecting">Offline</div>
  <!-- TABS -->
  <div id="tabs">
    <div class="tab active" data-tab="home">Home</div>
    <div class="tab" data-tab="dms">DMs</div>
    <div class="tab" data-tab="friends">Friends</div>
    <div class="tab" data-tab="news">News</div>
    <div class="tab" data-tab="shop">Shop</div>
    <div class="tab" data-tab="games">Games</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>
  <!-- APP -->
  <div id="app">
    <!-- SERVERS -->
    <div id="servers"></div>
    <!-- MAIN -->
    <div id="main">
      <!-- CHANNELS -->
      <div id="channels">
        <h3 id="serverName"># GENERAL</h3>
        <div id="channelList">
          <div class="chan active" data-chan="general"># general</div>
        </div>
        <button class="btn-small">+ Channel</button>
        <button class="btn-small invite">Invite</button>
      </div>
      <!-- CHAT -->
      <div id="chatArea">
        <div id="messages"></div>
        <div id="inputArea">
          <textarea id="msgInput" placeholder="Message #general..." rows="1"></textarea>
          <button id="sendBtn">SEND</button>
        </div>
      </div>
    </div>
  </div>
  <!-- DM VIEW -->
  <div id="dmView" style="display:none; flex:1; flex-direction:column;">
    <div style="padding:16px; border-bottom:1px solid var(--border); font-weight:600; color:var(--c1);">
      <span id="dmHeader">Select a user</span>
    </div>
    <div id="messages" style="flex:1; padding:20px; overflow-y:auto;"></div>
    <div id="inputArea" style="padding:16px; background:rgba(0,0,0,0.9); border-top:2px solid var(--c2);">
      <textarea id="msgInput" placeholder="Type a message..." rows="1" style="flex:1;"></textarea>
      <button id="sendBtn">SEND</button>
    </div>
  </div>
  <!-- FRIENDS VIEW -->
  <div id="friendsView" style="display:none; flex:1; flex-direction:column;">
    <div style="padding:16px; border-bottom:1px solid var(--border); font-weight:600; color:var(--c1);">
      <span>Friends</span>
    </div>
    <div id="friendsList" style="flex:1; padding:20px; overflow-y:auto;"></div>
    <div style="padding:8px; display: flex; align-items: center;">
      <input type="text" id="addFriendInput" class="input" placeholder="Enter username to add..." style="width: 70%; margin-right: 10px;">
      <button id="addFriendBtn" class="btn-small" style="width: 25%;">Add Friend</button>
    </div>
  </div>
  <!-- NEWS VIEW -->
  <div id="newsView" style="display:none; flex:1; flex-direction:column;">
    <div style="padding:16px; border-bottom:1px solid var(--border); font-weight:600; color:var(--c1);">
      <span>News</span>
    </div>
    <div id="newsFeed" style="flex:1; padding:20px; overflow-y:auto;"></div>
  </div>
  <!-- SHOP VIEW -->
  <div id="shopView" style="display:none; flex:1; flex-direction:column;">
    <div style="padding:16px; border-bottom:1px solid var(--border); font-weight:600; color:var(--c1);">
      <span>Shop</span>
      <span id="pointsDisplay">Points: 0</span>
    </div>
    <div id="shopItems" style="flex:1; padding:20px; overflow-y:auto;"></div>
  </div>
  <!-- GAMES VIEW -->
  <div id="gamesView" style="display:none; flex:1; flex-direction:column;">
    <div style="padding:16px; border-bottom:1px solid var(--border); font-weight:600; color:var(--c1);">
      <span>Games</span>
    </div>
    <div id="gameArea" style="flex:1; padding:20px; overflow-y:auto;">
      <div id="gameContainer" class="game-container">
        <h4>Random Game</h4>
        <p id="gameInstructions"></p>
        <button id="playBtn">Play</button>
        <div id="gameResult"></div>
      </div>
    </div>
  </div>
  <!-- SETTINGS -->
  <div id="settingsView" style="display:none; padding:32px; max-width:600px; margin:auto;">
    <div style="background:var(--card); padding:20px; border-radius:var(--radius); border:1px solid var(--border);">
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--c1);">Avatar</label>
        <input type="file" id="avatarInput" accept="image/*" style="margin-bottom:8px;" />
        <img id="avatarPreview" src="https://i.pravatar.cc/80" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--c1); object-fit:cover;" />
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--c1);">Name</label>
        <input id="nameInput" class="input" />
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--c1);">Bio</label>
        <textarea id="bioInput" rows="3" class="input" style="resize:vertical;"></textarea>
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--c1);">Wallpaper</label>
        <input type="file" id="wallpaperInput" accept="image/*" />
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--c1);">Theme</label>
        <select id="themeSelect" class="input">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--c1);">Status</label>
        <select id="statusSelect" class="input">
          <option value="online">Online</option>
          <option value="idle">Idle</option>
          <option value="dnd">Do Not Disturb</option>
          <option value="invisible">Invisible</option>
        </select>
      </div>
      <button class="btn">Save Settings</button>
      <button class="btn" style="width:100%; margin-top:10px; background:#f55;">Logout</button>
    </div>
  </div>
  <!-- INVITE MODAL -->
  <div id="inviteModal">
    <div id="inviteBox">
      <h3 style="color:var(--c1);">Invite to <span id="inviteServerName"></span></h3>
      <div id="inviteLink">Loading...</div>
      <button class="copy-btn">Copy Link</button>
      <button class="btn" style="margin-top:10px; background:#f55;">Close</button>
    </div>
  </div>
  <!-- USER PANEL -->
  <div id="userPanel">
    <img id="userAvatar" src="https://i.pravatar.cc/80" />
    <div>
      <div id="userName">Guest</div>
      <div id="userStatus">online</div>
      <div id="userBio" style="font-size:10px; color:#aaa; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>
    </div>
  </div>
  <!-- SCRIPT -->
  <script>
    console.log('Script started');
    try {
      // === GLOBALS ===
      const loginScreen = document.getElementById('loginScreen');
      const clockEl = document.getElementById('clock');
      const tabs = document.querySelectorAll('.tab');
      const app = document.getElementById('app');
      const dmView = document.getElementById('dmView');
      const friendsView = document.getElementById('friendsView');
      const newsView = document.getElementById('newsView');
      const shopView = document.getElementById('shopView');
      const gamesView = document.getElementById('gamesView');
      const settingsView = document.getElementById('settingsView');
      const connectionStatus = document.getElementById('connectionStatus');
      const notifications = document.getElementById('notifications');
      const playersOnline = document.getElementById('playersOnline');
      const pointsDisplay = document.getElementById('pointsDisplay');
      const playBtn = document.getElementById('playBtn');
      const gameInstructions = document.getElementById('gameInstructions');
      const gameResult = document.getElementById('gameResult');
      const forgotPasswordModal = document.getElementById('forgotPasswordModal');
      const forgotPasswordLink = document.getElementById('forgotPasswordLink');
      const resetPasswordBtn = document.getElementById('resetPasswordBtn');
      const closeForgotModalBtn = document.getElementById('closeForgotModalBtn');
      let socket = null, myName, currentServer = 'home', currentChat = 'general';
      let servers = {}, onlineUsers = {}, points = 0;
      let localMessages = JSON.parse(localStorage.getItem('ghostcordMessages') || '{}');
      let friends = JSON.parse(localStorage.getItem('ghostcordFriends') || '{}');
      let shopItems = {
        'effect1': { name: 'Glow Effect', cost: 50, type: 'effect', data: '0 0 10px #0ff, 0 0 20px rgba(0,255,255,0.5)' },
        'effect2': { name: 'Pulse Effect', cost: 75, type: 'effect', data: 'aura-pulse 2s infinite ease-in-out' },
        'wallpaper1': { name: 'Neon Grid', cost: 100, type: 'wallpaper', data: 'ur[](https://example.com/neon-grid.jpg)' },
        'wallpaper2': { name: 'Dark Space', cost: 150, type: 'wallpaper', data: 'ur[](https://example.com/dark-space.jpg)' }
      };

      // === NOTIFICATIONS ===
      function showNotification(message) {
        notifications.style.display = 'block';
        notifications.textContent = message;
        setTimeout(() => notifications.style.display = 'none', 3000);
      }

      // === LOGIN ===
      let isSignup = false;
      const authBtn = document.getElementById('authBtn');
      const switchLink = document.getElementById('switchLink');
      authBtn.addEventListener('click', () => {
        console.log('authBtn clicked');
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        isSignup ? signup(u, p) : login(u, p);
      });
      switchLink.addEventListener('click', () => {
        console.log('switchLink clicked');
        isSignup = !isSignup;
        document.getElementById('loginTitle').textContent = isSignup ? "Create Account" : "Sign In";
        authBtn.textContent = isSignup ? "Sign Up" : "Sign In";
        document.getElementById('switchText').innerHTML = isSignup ? "Have an account? " : "Don't have an account? ";
        switchLink.textContent = isSignup ? "Sign In" : "Create one";
      });

      function signup(u, p) {
        console.log('Signup:', u);
        if (!u || !p) return showNotification("Fill all fields!");
        if (u.length < 3 || p.length < 4) return showNotification("Username 3+, Password 4+!");
        const key = `user_${u}`;
        if (localStorage.getItem(key)) return showNotification("Username taken!");
        localStorage.setItem(key, JSON.stringify({
          password: p, settings: {}, points: 0,
          servers: { home: { name: 'Home', channels: ['general'], members: [u] } }
        }));
        showNotification("Account created!");
        login(u, p);
      }

      function login(u, p) {
        console.log('Logging in:', u);
        const key = `user_${u}`;
        try {
          const data = localStorage.getItem(key);
          if (!data || JSON.parse(data).password !== p) {
            return showNotification("Wrong credentials!");
          }
          const userData = JSON.parse(data);
          points = userData.points || 0;
          localStorage.setItem('ghostcordAccount', JSON.stringify({ username: u, password: p }));
          loginScreen.style.display = 'none';
          console.log('loginScreen hidden');
          initApp();
        } catch (e) {
          console.error('Login error:', e);
          showNotification('Login failed. Check Console for details or try a different username/password.');
        }
      }

      function logout() {
        console.log('Logout');
        if (confirm("Logout?")) {
          localStorage.removeItem('ghostcordAccount');
          location.reload();
        }
      }

      // === FORGOT PASSWORD ===
      forgotPasswordLink.addEventListener('click', () => {
        console.log('Forgot Password link clicked');
        forgotPasswordModal.style.display = 'flex';
      });

      closeForgotModalBtn.addEventListener('click', () => {
        console.log('Close forgot password modal clicked');
        forgotPasswordModal.style.display = 'none';
        document.getElementById('forgotPasswordInput').value = '';
      });

      resetPasswordBtn.addEventListener('click', () => {
        console.log('Reset Password button clicked');
        const username = document.getElementById('forgotPasswordInput').value.trim();
        if (!username) {
          showNotification('Please enter your username!');
          return;
        }
        const key = `user_${username}`;
        const userData = localStorage.getItem(key);
        if (!userData) {
          showNotification('Username not found!');
          return;
        }
        const newPassword = Math.random().toString(36).slice(-8); // Generate a random 8-character password
        const parsedData = JSON.parse(userData);
        parsedData.password = newPassword;
        localStorage.setItem(key, JSON.stringify(parsedData));
        showNotification(`Your new password is: ${newPassword}. Please log in with it and change it in settings!`);
        forgotPasswordModal.style.display = 'none';
        document.getElementById('forgotPasswordInput').value = '';
      });

      // Auto-login
      const saved = localStorage.getItem('ghostcordAccount');
      if (saved) {
        console.log('Attempting auto-login');
        try {
          const { username, password } = JSON.parse(saved);
          login(username, password);
        } catch (e) {
          console.error('Auto-login error:', e);
          showNotification('Auto-login failed. Please sign in manually.');
        }
      }

      // === MAIN APP ===
      function initApp() {
        console.log('Initializing app');
        try {
          myName = JSON.parse(localStorage.getItem('ghostcordAccount')).username;
          // Try socket connection
          if (typeof io !== 'undefined') {
            try {
              socket = io();
              console.log('Socket.io initialized');
            } catch (e) {
              console.error('Socket.io connection failed:', e);
              connectionStatus.textContent = 'Offline';
              connectionStatus.className = 'status-connecting';
              showNotification('Running in offline mode. Messages will be stored locally.');
            }
          } else {
            console.error('Socket.io not loaded');
            connectionStatus.textContent = 'Offline';
            connectionStatus.className = 'status-connecting';
            showNotification('Running in offline mode. Messages will be stored locally.');
          }
          // Load user data
          const userData = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
          servers = userData.servers || { home: { name: 'Home', channels: ['general'], members: [myName] } };
          points = userData.points || 0;
          saveUserData();

          // Clock
          function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', {
              timeZone: 'America/Toronto', hour: '2-digit', minute: '2-digit', hour12: true
            });
            const date = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            clockEl.innerHTML = `<strong>${date}</strong> <span style="color:var(--c1);">${time} EST</span>`;
          }
          updateClock();
          setInterval(updateClock, 1000);

          // Players Online
          function updatePlayersOnline() {
            const count = Object.keys(onlineUsers).length || 0;
            playersOnline.textContent = `Players: ${count}`;
          }

          // Render servers
          function renderServers() {
            console.log('Rendering servers');
            const srvList = document.getElementById('servers');
            srvList.innerHTML = '';
            Object.keys(servers).forEach(id => {
              const s = servers[id];
              const div = document.createElement('div');
              div.className = 'srv';
              div.textContent = s.name[0].toUpperCase();
              div.dataset.name = s.name;
              div.dataset.id = id;
              div.addEventListener('click', () => {
                console.log('Server clicked:', id);
                switchServer(id);
              });
              if (id === currentServer) div.style.background = '#0f0';
              srvList.appendChild(div);
            });
            const add = document.createElement('div');
            add.className = 'srv add';
            add.textContent = '+';
            add.addEventListener('click', () => {
              console.log('Add server clicked');
              createServer();
            });
            srvList.appendChild(add);
          }

          function createServer() {
            console.log('Creating server');
            const name = prompt("Server name:");
            if (!name) return;
            const id = Date.now().toString();
            servers[id] = { name, channels: ['general'], members: [myName] };
            saveUserData();
            renderServers();
            switchServer(id);
          }

          function switchServer(id) {
            console.log('Switching to server:', id);
            currentServer = id;
            const s = servers[id];
            document.getElementById('serverName').textContent = `# ${s.name.toUpperCase()}`;
            const channelList = document.getElementById('channelList');
            channelList.innerHTML = '';
            s.channels.forEach(ch => {
              const div = document.createElement('div');
              div.className = 'chan';
              div.dataset.chan = ch;
              div.innerHTML = `# ${ch} <span class="delete">×</span>`;
              div.addEventListener('click', e => {
                if (e.target.classList.contains('delete')) {
                  console.log('Remove channel:', ch);
                  removeChannel(ch);
                  return;
                }
                console.log('Channel clicked:', ch);
                document.querySelectorAll('.chan').forEach(c => c.classList.remove('active'));
                div.classList.add('active');
                currentChat = ch;
                document.querySelector('#app #msgInput').placeholder = `Message #${ch}...`;
                document.querySelector('#app #msgInput').focus();
                loadMessages();
              });
              if (ch === 'general') div.classList.add('active');
              channelList.appendChild(div);
            });
            renderServers();
            document.getElementById('messages').innerHTML = '';
            document.querySelector('#app #msgInput').placeholder = 'Message #general...';
            currentChat = 'general';
            loadMessages();
          }

          function addChannel() {
            console.log('Adding channel');
            const name = prompt("Channel name:");
            if (name && !servers[currentServer].channels.includes(name)) {
              showNotification(`Add channel "${name}"?`);
              const acceptBtn = document.createElement('button');
              acceptBtn.textContent = 'Accept Changes';
              acceptBtn.className = 'btn-small';
              acceptBtn.style.marginLeft = '10px';
              acceptBtn.addEventListener('click', () => {
                servers[currentServer].channels.push(name);
                saveUserData();
                switchServer(currentServer);
                showNotification(`Channel "${name}" added!`);
                notifications.removeChild(acceptBtn);
              });
              notifications.appendChild(acceptBtn);
            }
          }

          function removeChannel(ch) {
            console.log('Removing channel:', ch);
            showNotification(`Remove channel "${ch}"?`);
            const acceptBtn = document.createElement('button');
            acceptBtn.textContent = 'Accept Changes';
            acceptBtn.className = 'btn-small';
            acceptBtn.style.marginLeft = '10px';
            acceptBtn.addEventListener('click', () => {
              servers[currentServer].channels = servers[currentServer].channels.filter(c => c !== ch);
              saveUserData();
              switchServer(currentServer);
              showNotification(`Channel "${ch}" removed!`);
              notifications.removeChild(acceptBtn);
            });
            notifications.appendChild(acceptBtn);
          }

          function saveUserData() {
            console.log('Saving user data');
            const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
            data.servers = servers;
            data.points = points;
            localStorage.setItem(`user_${myName}`, JSON.stringify(data));
          }

          // Invite
          function showInvite() {
            console.log('Showing invite modal');
            const link = `${window.location.origin}/join.html?s=${currentServer}`;
            document.getElementById('inviteServerName').textContent = servers[currentServer].name;
            document.getElementById('inviteLink').textContent = link;
            document.getElementById('inviteModal').style.display = 'flex';
          }

          function copyInvite() {
            console.log('Copying invite link');
            navigator.clipboard.writeText(document.getElementById('inviteLink').textContent).then(() => {
              showNotification("Invite link copied!");
            });
          }

          function closeInvite() {
            console.log('Closing invite modal');
            document.getElementById('inviteModal').style.display = 'none';
          }

          // Tabs
          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              console.log('Tab clicked:', tab.dataset.tab);
              tabs.forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              app.style.display = 'none';
              dmView.style.display = 'none';
              friendsView.style.display = 'none';
              newsView.style.display = 'none';
              shopView.style.display = 'none';
              gamesView.style.display = 'none';
              settingsView.style.display = 'none';
              if (tab.dataset.tab === 'home') {
                app.style.display = 'flex';
                document.querySelector('#app #msgInput').focus();
              }
              if (tab.dataset.tab === 'dms') {
                dmView.style.display = 'flex';
                document.querySelector('#dmView #msgInput').focus();
              }
              if (tab.dataset.tab === 'friends') {
                friendsView.style.display = 'flex';
                updateFriendsList();
              }
              if (tab.dataset.tab === 'news') {
                newsView.style.display = 'flex';
                updateNewsFeed();
              }
              if (tab.dataset.tab === 'shop') {
                shopView.style.display = 'flex';
                updateShop();
              }
              if (tab.dataset.tab === 'games') {
                gamesView.style.display = 'flex';
                selectRandomGame();
              }
              if (tab.dataset.tab === 'settings') {
                settingsView.style.display = 'block';
              }
            });
          });

          // Socket
          if (socket) {
            socket.on('connect', () => {
              console.log('Socket connected');
              connectionStatus.textContent = 'Connected';
              connectionStatus.className = 'status-connected';
              socket.emit('join', { name: myName });
              // Earn points for activity (e.g., every 5 minutes online)
              setInterval(() => {
                points += 1;
                saveUserData();
                pointsDisplay.textContent = `Points: ${points}`;
                showNotification('Earned 1 point for being active!');
              }, 300000); // 5 minutes
            });
            socket.on('connect_error', (err) => {
              console.error('Socket connection error:', err);
              connectionStatus.textContent = 'Offline';
              connectionStatus.className = 'status-connecting';
              showNotification('Running in offline mode. Messages will be stored locally.');
            });
            socket.on('users', users => {
              console.log('Received users:', users);
              onlineUsers = users;
              updateDMList();
              updateFriendsList();
              updatePlayersOnline();
            });
            socket.on('msg', d => {
              if (d.server !== currentServer || d.channel !== currentChat) return;
              appendMessage(d.msg);
            });
            socket.on('dm', d => {
              if (currentChat !== `dm:${d.from}` && currentChat !== `dm:${d.to}`) return;
              appendMessage(d.msg, d.from);
            });
            socket.on('friendRequest', data => {
              if (data.to === myName && !friends[data.from]) {
                friends[data.from] = 'pending';
                saveUserData();
                updateFriendsList();
                showNotification(`Received friend request from ${data.from}!`);
              }
            });
            socket.on('friendResponse', data => {
              if (data.to === myName) {
                friends[data.from] = data.accepted ? 'online' : undefined;
                saveUserData();
                updateFriendsList();
                showNotification(data.accepted ? `${data.from} accepted your friend request!` : `${data.from} rejected your friend request.`);
              }
            });
          }

          function updateDMList() {
            console.log('Updating DM list');
            const dmList = document.getElementById('dmList');
            dmList.innerHTML = '';
            Object.keys(onlineUsers).forEach(name => {
              if (name === myName) return;
              const div = document.createElement('div');
              div.className = 'dm-user';
              div.innerHTML = `
                <div class="status-dot" style="background:${onlineUsers[name] === 'online' ? 'var(--online)' : '#666'}"></div>
                <span>${name}</span>
              `;
              div.addEventListener('click', () => {
                console.log('DM user clicked:', name);
                openDM(name);
              });
              dmList.appendChild(div);
            });
            if (!Object.keys(onlineUsers).length) {
              const div = document.createElement('div');
              div.className = 'dm-user';
              div.innerHTML = '<div class="status-dot" style="background:#666"></div><span>TestUser</span>';
              div.addEventListener('click', () => {
                console.log('DM user clicked: TestUser');
                openDM('TestUser');
              });
              dmList.appendChild(div);
            }
          }

          function updateFriendsList() {
            console.log('Updating friends list');
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';
            if (Object.keys(friends).length === 0) {
              friends = { 'friend1': 'offline', 'friend2': 'online', 'friend3': 'idle' };
              localStorage.setItem('ghostcordFriends', JSON.stringify(friends));
            }
            Object.keys(friends).forEach(name => {
              const div = document.createElement('div');
              div.className = `friend ${friends[name] === 'online' ? '' : 'offline'} ${friends[name] === 'pending' ? 'pending' : ''}`;
              div.innerHTML = `
                <div class="status-dot" style="background:${{
                  'online': 'var(--online)',
                  'idle': 'var(--idle)',
                  'offline': '#666',
                  'pending': '#666'
                }[friends[name]] || '#666'}"></div>
                <span>${name}</span>
              `;
              if (friends[name] === 'pending') {
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'accept-btn';
                acceptBtn.textContent = '✔';
                acceptBtn.addEventListener('click', () => {
                  friends[name] = 'online';
                  saveUserData();
                  updateFriendsList();
                  showNotification(`${name} added as a friend!`);
                  if (socket) socket.emit('friendResponse', { to: name, from: myName, accepted: true });
                });
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'reject-btn';
                rejectBtn.textContent = '✖';
                rejectBtn.addEventListener('click', () => {
                  delete friends[name];
                  saveUserData();
                  updateFriendsList();
                  showNotification(`${name} friend request rejected.`);
                  if (socket) socket.emit('friendResponse', { to: name, from: myName, accepted: false });
                });
                div.appendChild(acceptBtn);
                div.appendChild(rejectBtn);
              }
              div.addEventListener('click', () => {
                if (friends[name] !== 'pending') {
                  console.log('Friend clicked:', name);
                  openDM(name);
                }
              });
              friendsList.appendChild(div);
            });
            document.getElementById('addFriendInput').value = '';
          }

          function addFriend() {
            console.log('Adding friend');
            const friendName = document.getElementById('addFriendInput').value.trim();
            if (!friendName || friendName === myName) return showNotification("Invalid username!");
            if (friends[friendName]) return showNotification("Already a friend or pending!");
            if (socket && connectionStatus.textContent === 'Connected') {
              socket.emit('friendRequest', { to: friendName, from: myName });
              friends[friendName] = 'pending';
              saveUserData();
              updateFriendsList();
              showNotification(`Sent friend request to ${friendName}!`);
            } else {
              showNotification("You need to be online to add friends!");
            }
          }

          function updateNewsFeed() {
            console.log('Updating news feed');
            const newsFeed = document.getElementById('newsFeed');
            newsFeed.innerHTML = '';
            const newsItems = [
              { title: 'GHOSTCORD v6.1 Update', content: 'New features coming soon! Stay tuned.' },
              { title: 'Server Maintenance', content: 'Scheduled for Nov 20, 2025, 2:00 AM EST.' }
            ];
            newsItems.forEach(item => {
              const div = document.createElement('div');
              div.className = 'news-item';
              div.innerHTML = `<h4>${item.title}</h4><p>${item.content}</p>`;
              newsFeed.appendChild(div);
            });
          }

          function updateShop() {
            console.log('Updating shop');
            const shopItemsEl = document.getElementById('shopItems');
            shopItemsEl.innerHTML = '';
            Object.entries(shopItems).forEach(([id, item]) => {
              const div = document.createElement('div');
              div.className = 'shop-item';
              div.innerHTML = `
                <div>
                  <h4>${item.name}</h4>
                  <p>Cost: ${item.cost} points</p>
                </div>
                <button class="buy-btn" data-id="${id}" ${points < item.cost ? 'disabled' : ''}>
                  ${points < item.cost ? 'Not Enough Points' : 'Buy'}
                </button>
              `;
              div.querySelector('.buy-btn').addEventListener('click', () => {
                if (points >= item.cost) {
                  points -= item.cost;
                  saveUserData();
                  pointsDisplay.textContent = `Points: ${points}`;
                  if (item.type === 'effect') {
                    document.getElementById('userAvatar').style.boxShadow = item.data;
                  } else if (item.type === 'wallpaper') {
                    document.body.style.setProperty('--wallpaper', item.data);
                  }
                  showNotification(`Purchased ${item.name}!`);
                  updateShop();
                }
              });
              shopItemsEl.appendChild(div);
            });
          }

          function selectRandomGame() {
            const games = [
              {
                name: 'Number Guessing',
                instructions: 'Guess a number between 1 and 100. Enter your guess below!',
                play: () => {
                  const target = Math.floor(Math.random() * 100) + 1;
                  gameInstructions.textContent = 'Guess a number between 1 and 100. Enter your guess below!';
                  playBtn.style.display = 'none';
                  const input = document.createElement('input');
                  input.type = 'number';
                  input.min = 1;
                  input.max = 100;
                  input.className = 'input';
                  input.style.width = '200px';
                  input.style.marginTop = '10px';
                  const submitBtn = document.createElement('button');
                  submitBtn.textContent = 'Submit Guess';
                  submitBtn.className = 'btn-small';
                  submitBtn.style.marginLeft = '10px';
                  const gameArea = document.getElementById('gameArea');
                  gameArea.appendChild(input);
                  gameArea.appendChild(submitBtn);
                  gameResult.textContent = '';

                  submitBtn.addEventListener('click', () => {
                    const guess = parseInt(input.value);
                    if (isNaN(guess) || guess < 1 || guess > 100) {
                      gameResult.textContent = 'Please enter a valid number between 1 and 100!';
                      return;
                    }
                    if (guess === target) {
                      points += 10;
                      saveUserData();
                      pointsDisplay.textContent = `Points: ${points}`;
                      gameResult.textContent = `Congratulations! You guessed it! Earned 10 points.`;
                      gameArea.removeChild(input);
                      gameArea.removeChild(submitBtn);
                      playBtn.style.display = 'block';
                    } else if (guess < target) {
                      gameResult.textContent = 'Too low! Try again.';
                    } else {
                      gameResult.textContent = 'Too high! Try again.';
                    }
                  });
                }
              },
              {
                name: 'Click Challenge',
                instructions: 'Click the button as many times as you can in 10 seconds!',
                play: () => {
                  let clicks = 0;
                  gameInstructions.textContent = 'Click the button as many times as you can in 10 seconds!';
                  playBtn.textContent = 'Click Me!';
                  gameResult.textContent = 'Get ready...';
                  let timeLeft = 10;
                  const timer = setInterval(() => {
                    timeLeft--;
                    gameResult.textContent = `Time left: ${timeLeft} seconds`;
                    if (timeLeft <= 0) {
                      clearInterval(timer);
                      playBtn.removeEventListener('click', handleClick);
                      playBtn.textContent = 'Play';
                      points += Math.floor(clicks / 5); // 1 point per 5 clicks
                      saveUserData();
                      pointsDisplay.textContent = `Points: ${points}`;
                      gameResult.textContent = `Game over! You clicked ${clicks} times. Earned ${Math.floor(clicks / 5)} points!`;
                    }
                  }, 1000);
                  const handleClick = () => clicks++;
                  playBtn.addEventListener('click', handleClick);
                }
              }
            ];
            const randomGame = games[Math.floor(Math.random() * games.length)];
            document.getElementById('gameContainer').querySelector('h4').textContent = randomGame.name;
            gameInstructions.textContent = randomGame.instructions;
            gameResult.textContent = '';
            playBtn.onclick = randomGame.play;
          }

          function openDM(user) {
            console.log('Opening DM with:', user);
            currentChat = `dm:${user}`;
            document.getElementById('dmHeader').textContent = `@${user}`;
            document.getElementById('messages').innerHTML = '';
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="dms"]').classList.add('active');
            app.style.display = 'none';
            dmView.style.display = 'flex';
            friendsView.style.display = 'none';
            newsView.style.display = 'none';
            shopView.style.display = 'none';
            gamesView.style.display = 'none';
            settingsView.style.display = 'none';
            document.querySelector('#dmView #msgInput').placeholder = `Message @${user}...`;
            document.querySelector('#dmView #msgInput').focus();
            loadMessages();
          }

          function sendMsg(e, context = 'app') {
            console.log('Send message attempted in context:', context);
            const input = document.querySelector(`#${context} #msgInput`);
            const txt = input.value.trim();
            if (!txt) return;
            const msg = { user: myName, text: txt, time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) };
            const key = currentChat.startsWith('dm:') ? currentChat : `${currentServer}:${currentChat}`;
            localMessages[key] = localMessages[key] || [];
            localMessages[key].push(msg);
            localStorage.setItem('ghostcordMessages', JSON.stringify(localMessages));
            appendMessage(msg);
            if (socket) {
              try {
                if (currentChat.startsWith('dm:')) {
                  const target = currentChat.split(':')[1];
                  socket.emit('dm', { to: target, msg });
                } else {
                  socket.emit('msg', { server: currentServer, channel: currentChat, msg });
                }
              } catch (e) {
                console.error('Error sending message:', e);
              }
            }
            input.value = '';
            input.style.height = 'auto';
          }

          function loadMessages() {
            console.log('Loading messages for:', currentChat);
            const key = currentChat.startsWith('dm:') ? currentChat : `${currentServer}:${currentChat}`;
            const messages = localMessages[key] || [];
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML = '';
            messages.forEach(msg => appendMessage(msg));
          }

          function appendMessage(msg, from = null) {
            console.log('Appending message:', msg);
            const messages = document.getElementById('messages');
            const isOwn = msg.user === myName;
            const m = document.createElement('div');
            m.className = `msg ${isOwn ? 'own' : ''}`;
            m.innerHTML = `<strong>[${msg.time}] ${from || msg.user}:</strong> ${msg.text}`;
            messages.appendChild(m);
            messages.scrollTop = messages.scrollHeight;
          }

          // Settings
          function loadSettings() {
            console.log('Loading settings');
            const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
            const s = data.settings || {};
            document.body.style.setProperty('--wallpaper', s.wallpaper ? `url(${s.wallpaper})` : 'none');
            document.getElementById('userName').textContent = myName;
            document.getElementById('nameInput').value = myName;
            document.getElementById('bioInput').value = s.bio || '';
            document.getElementById('userBio').textContent = s.bio || '';
            document.getElementById('themeSelect').value = s.theme || 'dark';
            document.body.dataset.theme = s.theme || 'dark';
            document.getElementById('statusSelect').value = s.status || 'online';
            document.getElementById('userStatus').textContent = s.status || 'online';
            document.getElementById('userStatus').style.color = {
              online: 'var(--online)',
              idle: 'var(--idle)',
              dnd: 'var(--dnd)',
              invisible: 'var(--invisible)'
            }[s.status || 'online'];
            if (s.avatar) {
              document.getElementById('userAvatar').src = s.avatar;
              document.getElementById('avatarPreview').src = s.avatar;
            }
            pointsDisplay.textContent = `Points: ${points}`;
          }

          function saveSettings() {
            console.log('Saving settings');
            const bio = document.getElementById('bioInput').value;
            const theme = document.getElementById('themeSelect').value;
            const status = document.getElementById('statusSelect').value;
            const data = JSON.parse(localStorage.getItem(`user_${myName}`) || '{}');
            data.settings = data.settings || {};
            data.settings.bio = bio;
            data.settings.theme = theme;
            data.settings.status = status;
            const avatarFile = document.getElementById('avatarInput').files[0];
            const wpFile = document.getElementById('wallpaperInput').files[0];
            const save = () => {
              localStorage.setItem(`user_${myName}`, JSON.stringify(data));
              loadSettings();
              showNotification("Settings saved!");
            };
            if (avatarFile) {
              const reader = new FileReader();
              reader.onload = e => { data.settings.avatar = e.target.result; save(); };
              reader.readAsDataURL(avatarFile);
            } else if (wpFile) {
              const reader = new FileReader();
              reader.onload = e => { data.settings.wallpaper = e.target.result; save(); };
              reader.readAsDataURL(wpFile);
            } else {
              save();
            }
          }

          // Bind events
          function bindEvents() {
            console.log('Binding events');
            ['app', 'dmView'].forEach(context => {
              const input = document.querySelector(`#${context} #msgInput`);
              const btn = document.querySelector(`#${context} #sendBtn`);
              if (input) {
                input.disabled = false;
                input.addEventListener('click', () => console.log(`${context} msgInput clicked`));
                input.addEventListener('keydown', e => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    console.log(`${context} Enter pressed`);
                    sendMsg(e, context);
                  }
                });
              }
              if (btn) {
                btn.addEventListener('click', e => {
                  console.log(`${context} sendBtn clicked`);
                  sendMsg(e, context);
                });
              }
            });
            document.querySelectorAll('.btn-small').forEach(btn => {
              btn.addEventListener('click', e => {
                console.log('btn-small clicked:', btn.textContent);
                if (btn.textContent === '+ Channel') addChannel();
                if (btn.textContent === 'Invite') showInvite();
                if (btn.id === 'addFriendBtn') addFriend();
              });
            });
            document.querySelectorAll('.copy-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                console.log('copy-btn clicked');
                copyInvite();
              });
            });
            document.querySelectorAll('.btn').forEach(btn => {
              if (btn.textContent === 'Save Settings') {
                btn.addEventListener('click', () => {
                  console.log('Save Settings clicked');
                  saveSettings();
                });
              }
              if (btn.textContent === 'Logout') {
                btn.addEventListener('click', () => {
                  console.log('Logout clicked');
                  logout();
                });
              }
              if (btn.textContent === 'Close') {
                btn.addEventListener('click', () => {
                  console.log('Close invite clicked');
                  closeInvite();
                });
              }
            });
          }

          // Init
          console.log('Starting initialization');
          renderServers();
          switchServer('home');
          loadSettings();
          bindEvents();
          updateDMList();
          updateFriendsList();
          updateNewsFeed();
          updateShop();
          updatePlayersOnline();
          document.querySelector('#app #msgInput').focus();
        } catch (e) {
          console.error('Error in initApp:', e);
          showNotification('App initialization failed. Check Console for details.');
        }
      }
    } catch (e) {
      console.error('Global error:', e);
      showNotification('Critical error. Check Console for details.');
    }
  </script>
</body>

</html>
