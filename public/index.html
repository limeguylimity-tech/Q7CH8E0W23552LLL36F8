<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="ghost-plus.css">
<link rel="stylesheet" href="games-fixed.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GhostChat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

:root {
  /* Modern color palette */
  --primary: #5865F2;
  --primary-dark: #4752C4;
  --primary-light: #7289DA;
  --secondary: #EB459E;
  --accent: #57F287;
  --warning: #FEE75C;
  --danger: #ED4245;
  
  /* Backgrounds with glassmorphism */
  --bg-primary: #0F0F0F;
  --bg-secondary: #1A1A1A;
  --bg-tertiary: #232323;
  --bg-glass: rgba(26, 26, 26, 0.7);
  --bg-glass-hover: rgba(35, 35, 35, 0.9);
  
  /* Text colors */
  --text-primary: #FFFFFF;
  --text-secondary: #B9BBBE;
  --text-muted: #72767D;
  
  /* Borders */
  --border: rgba(255, 255, 255, 0.1);
  --border-hover: rgba(255, 255, 255, 0.2);
  
  /* Shadows */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
  --shadow-glow: 0 0 20px rgba(88, 101, 242, 0.3);
  
  /* Animations */
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* Radius */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 24px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
  /* Animated gradient background */
  background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 50%, #0F0F0F 100%);
  background-size: 200% 200%;
  animation: gradientShift 15s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--bg-tertiary);
  border-radius: 4px;
  transition: var(--transition-fast);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Glassmorphism effect */
.glass {
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--border);
}

/* Notifications */
#notifications {
  position: fixed;
  top: 80px;
  right: 20px;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  padding: 16px 24px;
  border-radius: var(--radius-md);
  border: 1px solid var(--primary);
  box-shadow: var(--shadow-glow);
  z-index: 10000;
  display: none;
  animation: slideInRight 0.3s ease;
  font-weight: 500;
}

@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Login Screen */
#loginScreen {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, rgba(88, 101, 242, 0.1) 0%, rgba(235, 69, 158, 0.1) 100%);
  backdrop-filter: blur(40px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loginBox {
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  padding: 48px;
  border-radius: var(--radius-xl);
  width: 420px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  animation: fadeInScale 0.4s ease;
}

@keyframes fadeInScale {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

#loginBox h2 {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  margin-bottom: 32px;
  font-size: 32px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.input {
  width: 100%;
  padding: 14px 18px;
  margin: 12px 0;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 500;
  outline: none;
  transition: var(--transition-fast);
}

.input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(88, 101, 242, 0.1);
  background: var(--bg-tertiary);
}

.input::placeholder {
  color: var(--text-muted);
}

.btn {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 14px;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  width: 100%;
  margin-top: 16px;
  transition: var(--transition-smooth);
  box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.switch {
  text-align: center;
  margin-top: 24px;
  color: var(--text-secondary);
  font-size: 14px;
}

.switch a {
  color: var(--primary);
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
  transition: var(--transition-fast);
}

.switch a:hover {
  color: var(--primary-light);
  text-decoration: underline;
}

/* Top Bar */
#topBar {
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
}

#topBarLeft, #topBarCenter, #topBarRight {
  display: flex;
  align-items: center;
  gap: 16px;
}

#userInfo {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  transition: var(--transition-fast);
  cursor: pointer;
}

#userInfo:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary);
}

#userAvatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--primary);
  object-fit: cover;
  transition: var(--transition-fast);
}

#userInfo:hover #userAvatar {
  border-color: var(--secondary);
  transform: scale(1.05);
}

#userName {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 14px;
}

#userStatus {
  font-size: 11px;
  color: var(--accent);
  font-weight: 500;
}

#clock {
  color: var(--text-secondary);
  font-weight: 500;
  font-size: 14px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

#playersOnline {
  background: linear-gradient(135deg, var(--secondary), var(--primary));
  color: white;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  font-size: 13px;
  box-shadow: 0 2px 8px rgba(235, 69, 158, 0.3);
}

/* Tabs */
#tabs {
  display: flex;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  gap: 4px;
  overflow-x: auto;
}

.tab {
  padding: 14px 24px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: var(--transition-fast);
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  position: relative;
  white-space: nowrap;
}

.tab:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
  background: var(--bg-secondary);
}

/* Main App */
#app {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* Servers Sidebar */
#servers {
  width: 72px;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  padding: 16px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  border-right: 1px solid var(--border);
  overflow-y: auto;
}

.srv {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-md);
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 18px;
  box-shadow: var(--shadow-sm);
  transition: var(--transition-smooth);
  position: relative;
}

.srv:hover {
  transform: translateY(-2px) scale(1.05);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-glow);
}

.srv.add {
  background: linear-gradient(135deg, var(--secondary), var(--danger));
  font-size: 28px;
}

.srv.active {
  border-radius: var(--radius-lg);
  box-shadow: 0 0 0 3px var(--primary);
}

.srv::after {
  content: attr(data-name);
  position: absolute;
  left: 64px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--bg-tertiary);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  opacity: 0;
  pointer-events: none;
  transition: var(--transition-fast);
  border: 1px solid var(--border);
  white-space: nowrap;
  z-index: 100;
  box-shadow: var(--shadow-md);
}

.srv:hover::after {
  opacity: 1;
}

/* Main Content */
#main {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* Channels Sidebar */
#channels {
  width: 240px;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  padding: 16px;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#channels h3 {
  color: var(--text-muted);
  margin: 0 8px 12px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 700;
}

#channelList {
  flex: 1;
  overflow-y: auto;
}

.chan {
  padding: 10px 12px;
  margin: 2px 0;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition-fast);
  font-size: 15px;
  font-weight: 500;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--text-secondary);
}

.chan:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.chan.active {
  background: var(--bg-secondary);
  color: var(--primary);
  font-weight: 600;
}

.chan .delete {
  color: var(--danger);
  font-size: 16px;
  cursor: pointer;
  opacity: 0;
  transition: var(--transition-fast);
}

.chan:hover .delete {
  opacity: 1;
}

/* Chat Area */
#chatArea {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  background: var(--bg-secondary);
}

#chatHeader {
  padding: 16px 24px;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-sm);
}

#chatHeader h3 {
  color: var(--text-primary);
  font-size: 18px;
  font-weight: 700;
}

#clearChatBtn {
  background: var(--danger);
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: var(--transition-fast);
}

#clearChatBtn:hover {
  background: #C03537;
  transform: translateY(-1px);
}

/* Messages */
#messages, #globalMessages, #dmMessages {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.msg {
  max-width: 70%;
  padding: 14px 18px;
  background: var(--bg-glass);
  backdrop-filter: blur(10px);
  border-left: 3px solid var(--primary);
  border-radius: var(--radius-md);
  align-self: flex-start;
  word-wrap: break-word;
  box-shadow: var(--shadow-sm);
  transition: var(--transition-fast);
  animation: messageSlideIn 0.3s ease;
}

@keyframes messageSlideIn {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.msg:hover {
  background: var(--bg-glass-hover);
  transform: translateX(2px);
}

.msg.own {
  align-self: flex-end;
  background: linear-gradient(135deg, rgba(88, 101, 242, 0.2), rgba(88, 101, 242, 0.1));
  border-left: none;
  border-right: 3px solid var(--secondary);
}

.msg strong {
  color: var(--primary);
  cursor: pointer;
  transition: var(--transition-fast);
}

.msg strong:hover {
  color: var(--primary-light);
  text-decoration: underline;
}

/* Input Area */
#inputArea, #globalInputArea {
  position: sticky;
  bottom: 0;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  padding: 20px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
  z-index: 10;
}

#msgInput, #dmInput, #globalMsgInput {
  flex: 1;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  color: var(--text-primary);
  padding: 14px 18px;
  border-radius: var(--radius-md);
  outline: none;
  font-size: 15px;
  font-weight: 500;
  min-height: 52px;
  resize: none;
  transition: var(--transition-fast);
  font-family: inherit;
}

#msgInput:focus, #dmInput:focus, #globalMsgInput:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(88, 101, 242, 0.1);
  background: var(--bg-tertiary);
}

#sendBtn, #dmSendBtn, #globalSendBtn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  padding: 0 28px;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 700;
  height: 52px;
  min-width: 80px;
  transition: var(--transition-smooth);
  box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
  font-size: 15px;
}

#sendBtn:hover, #dmSendBtn:hover, #globalSendBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
}

#sendBtn:active, #dmSendBtn:active, #globalSendBtn:active {
  transform: translateY(0);
}

/* Small Buttons */
.btn-small {
  background: var(--primary);
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  margin: 5px 8px;
  transition: var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.btn-small:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

/* Friends & Lists */
.friend, .dm-user, .server-item {
  padding: 14px 18px;
  margin: 8px;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 15px;
  font-weight: 500;
  background: var(--bg-glass);
  border: 1px solid var(--border);
  transition: var(--transition-fast);
}

.friend:hover, .dm-user:hover, .server-item:hover {
  background: var(--bg-glass-hover);
  border-color: var(--primary);
  transform: translateX(4px);
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
}

.offline .status-dot {
  background: var(--text-muted);
  box-shadow: none;
}

/* Modals */
#profileModal, #serverSettingsModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 10003;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#profileModal > div, #serverSettingsModal > div {
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  padding: 36px;
  border-radius: var(--radius-xl);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  min-width: 450px;
  animation: scaleIn 0.3s ease;
}

@keyframes scaleIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* Connection Status */
#connectionStatus {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  z-index: 10001;
  display: none;
  box-shadow: var(--shadow-md);
  animation: slideInRight 0.3s ease;
}

.status-connected {
  background: var(--accent);
  color: #000;
}

.status-connecting {
  background: var(--warning);
  color: #000;
}

/* Call UI */
#callUI {
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  border: 1px solid var(--primary);
  box-shadow: var(--shadow-glow);
}

/* Mobile buttons */
.mobile-menu-btn {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
}

.mobile-channels-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
}

.mobile-servers-btn {
  background: linear-gradient(135deg, var(--secondary), var(--danger));
}

/* Views (DMs, Friends, News, etc.) */
#dmView, #friendsView, #newsView, #shopView, #gamesView, #settingsView, #globalView, #serverListView {
  flex: 1;
  display: none;
  flex-direction: column;
  background: var(--bg-secondary);
  position: relative;
  overflow: hidden;
}

#dmHeader, #globalHeader, #serverListHeader {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  font-size: 18px;
}

#dmList, #friendsList, #newsFeed, #shopItems, #gameContainer, #serverList {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

/* Server List Items */
.server-item {
  flex-direction: column;
  align-items: flex-start;
}

.server-item h4 {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 16px;
}

.server-item p {
  color: var(--text-secondary);
  font-size: 13px;
  margin: 4px 0;
}

.server-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.join-btn {
  background: var(--primary);
  color: white;
  padding: 6px 16px;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: var(--transition-fast);
}

.join-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

/* Friends List Styles */
.pending {
  opacity: 0.7;
}

.accept-btn, .reject-btn {
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  border: none;
  font-weight: 600;
  transition: var(--transition-fast);
}

.accept-btn {
  background: var(--accent);
  color: #000;
}

.accept-btn:hover {
  background: #46D96C;
  transform: translateY(-1px);
}

.reject-btn {
  background: var(--danger);
  color: white;
}

.reject-btn:hover {
  background: #C03537;
  transform: translateY(-1px);
}

/* News, Shop, Games */
.news-item, .shop-item, .game-container {
  background: var(--bg-glass);
  backdrop-filter: blur(10px);
  padding: 18px 24px;
  border-radius: var(--radius-md);
  margin-bottom: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  transition: var(--transition-fast);
}

.news-item:hover, .shop-item:hover, .game-container:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.news-item h4, .shop-item h4, .game-container h4 {
  color: var(--primary);
  margin-bottom: 10px;
  font-size: 18px;
  font-weight: 700;
}

.news-item p, .shop-item p {
  color: var(--text-secondary);
  line-height: 1.5;
}

.buy-btn {
  background: var(--secondary);
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition-fast);
  margin-top: 12px;
}

.buy-btn:hover {
  background: #D63384;
  transform: translateY(-1px);
}

.buy-btn:disabled {
  background: var(--text-muted);
  cursor: not-allowed;
  transform: none;
}

#pointsDisplay {
  color: var(--primary);
  font-weight: 700;
  font-size: 20px;
  margin-bottom: 20px;
  padding: 16px;
  background: var(--bg-glass);
  backdrop-filter: blur(10px);
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
}

/* Settings View */
#settingsView {
  padding: 24px;
  overflow-y: auto;
  max-width: 600px;
  margin: 0 auto;
}

#settingsView h3 {
  color: var(--text-primary);
  margin: 24px 0 16px;
  font-size: 16px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#settingsView .input {
  margin: 8px 0;
}

#avatarPreview {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  margin: 16px 0;
  border: 3px solid var(--primary);
  object-fit: cover;
}

/* Admin Console */
#adminConsole {
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  padding: 24px;
  border-radius: var(--radius-lg);
  border: 2px solid var(--danger);
  box-shadow: 0 0 30px rgba(237, 66, 69, 0.3);
  z-index: 10004;
}

#adminConsole h3 {
  color: var(--danger);
  margin-bottom: 16px;
  font-size: 18px;
  font-weight: 700;
}

#adminResult {
  margin-top: 12px;
  font-size: 13px;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  background: var(--bg-secondary);
}

/* Call UI Enhancements */
#callUI {
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  border: 2px solid var(--primary);
  box-shadow: var(--shadow-glow);
  animation: fadeInScale 0.3s ease;
}

#callStatus {
  color: var(--primary);
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 16px;
}

#callUser {
  color: var(--text-primary);
  font-size: 16px;
  margin-bottom: 12px;
  font-weight: 500;
}

#callTimer {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 20px;
  font-weight: 600;
}

#localVideo, #remoteVideo {
  border-radius: var(--radius-md);
  border: 2px solid var(--primary);
}

#toggleVideoBtn, #toggleAudioBtn {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
}

#toggleVideoBtn:hover, #toggleAudioBtn:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary);
}

/* Profile Modal */
#profileModal > div {
  animation: scaleIn 0.3s ease;
}

#profileAvatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid var(--primary);
  object-fit: cover;
}

#profileName {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 24px;
  font-weight: 700;
}

#profileStatus {
  color: var(--accent);
  font-size: 14px;
  font-weight: 600;
}

#profileBio {
  color: var(--text-primary);
  margin-bottom: 16px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  min-height: 80px;
  line-height: 1.5;
}

#profilePoints, #profileJoined {
  color: var(--text-primary);
  font-weight: 600;
}

#profileDmBtn, #profileCallBtn {
  background: var(--secondary);
}

#profileDmBtn:hover, #profileCallBtn:hover {
  background: #D63384;
}

/* User Panel */
#userPanel {
  display: none;
  position: fixed;
  right: 20px;
  top: 80px;
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  padding: 24px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 280px;
}

/* Ensure smooth scrolling */
#messages, #globalMessages, #dmMessages, 
#channelList, #friendsList, #serverList,
#dmList, #newsFeed, #shopItems {
  scroll-behavior: smooth;
}

/* Fix auto-scroll */
.msg {
  scroll-margin-bottom: 20px;
}
  </style>
</head>
<body>
  <link rel="stylesheet" href="mobile.css">
  <div id="notifications"></div>

  <div id="loginScreen">
    <div id="loginBox">
      <h2 id="loginTitle">Sign In</h2>
      <input id="username" class="input" placeholder="Username" type="text" autocomplete="username">
      <input id="password" class="input" placeholder="Password" type="password" autocomplete="current-password">
      <button id="authBtn" class="btn">Sign In</button>
      <div class="switch"><span id="switchText">Don't have an account? </span><a id="switchLink">Create one</a></div>
    </div>
  </div>

  <div id="topBar">
    <div id="topBarLeft">
      <div id="userInfo">
        <img id="userAvatar" src="https://i.imgur.com/6VBx3io.png" alt="avatar">
        <div id="userDetails">
          <span id="userName"></span>
          <span id="userStatus"></span>
        </div>
      </div>
    </div>
    <div id="topBarCenter"><div id="clock"></div></div>
    <div id="topBarRight"><div id="playersOnline">Players: 0</div></div>
  </div>

  <div id="tabs">
    <div class="tab" data-tab="ghostplus">üëë GHOST+</div>
    <div class="tab active" data-tab="home">Home</div>
    <div class="tab" data-tab="serverlist">Servers</div>
    <div class="tab" data-tab="dms">DMs</div>
    <div class="tab" data-tab="friends">Friends</div>
    <div class="tab" data-tab="news">News</div>
    <div class="tab" data-tab="shop">Shop</div>
    <div class="tab" data-tab="games">Games</div>
    <div class="tab" data-tab="global">Global</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <div id="app">
    <div id="servers"><div class="srv add" id="addServerBtn">+</div></div>
    <div id="main">
      <div id="channels">
        <h3>Channels</h3>
        <div id="channelList"></div>
        <button id="addChannelBtn" class="btn-small">+ Channel</button>
      </div>
      <div id="chatArea">
        <div id="chatHeader">
          <h3 id="chatTitle">Select a channel</h3>
          <button id="clearChatBtn">Clear Chat</button>
        </div>
        <div id="messages"></div>
        <div id="inputArea">
          <textarea id="msgInput" placeholder="Select a server..."></textarea>
          <button id="sendBtn" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <div id="serverListView">
    <div id="serverListHeader"><h3>All Servers</h3></div>
    <div id="serverList"></div>
  </div>

  <div id="dmView">
    <div id="dmHeader">
      <span>Select a DM</span>
      <button id="clearDmBtn" class="btn-small" style="background:#f55;">Clear</button>
    </div>
    <div id="dmMessages"></div>
    <div id="inputArea">
      <textarea id="dmInput" placeholder="Select a DM..."></textarea>
      <button id="dmSendBtn" disabled>Send</button>
    </div>
  </div>

  <div id="globalView">
    <div id="globalHeader">
      <span>Global Chat</span>
      <button id="clearGlobalBtn" class="btn-small" style="background:#f55;">Clear</button>
    </div>
    <div id="globalMessages"></div>
    <div id="globalInputArea">
      <textarea id="globalMsgInput" placeholder="Say something..."></textarea>
      <button id="globalSendBtn">Send</button>
    </div>
  </div>

  <div id="friendsView">
    <input id="addFriendInput" class="input" placeholder="Add friend...">
    <button id="addFriendBtn" class="btn-small">Add</button>
    <div id="friendsList"></div>
  </div>
  <div id="newsView"><div id="newsFeed"></div></div>
  <div id="shopView"><div id="pointsDisplay">Points: 0</div><div id="shopItems"></div></div>
  <div id="gamesView">
  <div class="games-grid">
    <div class="game-card" onclick="playGame('trivia')">
      <div class="game-thumbnail">üß†</div>
      <div class="game-info">
        <div class="game-title">Trivia Challenge</div>
        <button class="play-game-btn">Play Now</button>
      </div>
    </div>
    
    <div class="game-card" onclick="playGame('number')">
      <div class="game-thumbnail">üî¢</div>
      <div class="game-info">
        <div class="game-title">Number Guess</div>
        <button class="play-game-btn">Play Now</button>
      </div>
    </div>
  </div>
</div>

  <div id="settingsView">
    <input id="nameInput" class="input" placeholder="Name" readonly>
    <input id="bioInput" class="input" placeholder="Bio">
    <select id="themeSelect" class="input"><option value="dark">Dark</option><option value="light">Light</option></select>
    <select id="statusSelect" class="input"><option value="online">Online</option><option value="idle">Idle</option><option value="dnd">DND</option><option value="invisible">Invisible</option></select>
    <button id="saveSettingsBtn" class="btn">Save Settings</button>
    <button id="logoutBtn" class="btn">Logout</button>
    <div style="margin-top:30px;padding-top:30px;border-top:2px solid var(--border);">
      <h3 style="color:#f55;margin-bottom:10px;">Danger Zone</h3>
      <button id="deleteAccountBtn" class="btn" style="background:#f55;">Delete Account</button>
    </div>
  </div>

  <div id="connectionStatus" class="status-connecting" style="display:none;">Connecting...</div>

  <div id="callUI" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);padding:32px;border-radius:var(--radius);border:2px solid var(--c1);box-shadow:0 0 40px rgba(0,255,255,.5);z-index:10002;min-width:300px;text-align:center;">
    <div id="callStatus" style="color:var(--c1);font-size:18px;font-weight:600;margin-bottom:20px;">Calling...</div>
    <div id="callUser" style="color:var(--text);font-size:16px;margin-bottom:20px;"></div>
    <div id="callTimer" style="color:#aaa;font-size:14px;margin-bottom:20px;">00:00</div>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button id="acceptCallBtn" class="btn" style="background:var(--online);display:none;">Accept</button>
      <button id="endCallBtn" class="btn" style="background:#f55;">End Call</button>
    </div>
  </div>

  <script>
    let socket = null;
    let myName = null, currentServer = null, currentChannel = null, currentDM = null;
    let servers = {}, onlineUsers = {}, friends = {}, points = 0, allServers = {};
    let userData = {};

    // FIXED WebRTC Implementation
    let peerConnection = null;
    let localStream = null;
    let remoteAudio = null;
    let currentCall = null;
    let callTimer = null;
    let callStartTime = null;
    let pendingIceCandidates = [];
    let isRemoteDescriptionSet = false;

    const iceConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        {
          urls: 'turn:openrelay.metered.ca:80',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        },
        {
          urls: 'turn:openrelay.metered.ca:443',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        }
      ],
      iceCandidatePoolSize: 10
    };

    const els = {
      loginScreen: document.getElementById('loginScreen'),
      notifications: document.getElementById('notifications'),
      clock: document.getElementById('clock'),
      playersOnline: document.getElementById('playersOnline'),
      userAvatar: document.getElementById('userAvatar'),
      userName: document.getElementById('userName'),
      userStatus: document.getElementById('userStatus'),
      connectionStatus: document.getElementById('connectionStatus'),
      globalMessages: document.getElementById('globalMessages'),
      globalMsgInput: document.getElementById('globalMsgInput'),
      globalSendBtn: document.getElementById('globalSendBtn'),
      chatTitle: document.getElementById('chatTitle'),
      clearChatBtn: document.getElementById('clearChatBtn'),
      clearDmBtn: document.getElementById('clearDmBtn'),
      clearGlobalBtn: document.getElementById('clearGlobalBtn')
    };

    function show(msg) { 
      els.notifications.textContent = msg; 
      els.notifications.style.display = 'block'; 
      setTimeout(() => els.notifications.style.display = 'none', 3000); 
    }

    let isSignup = false;
    document.getElementById('authBtn').onclick = () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) return show('Fill all fields');
      isSignup ? signup(u, p) : login(u, p);
    };
    
    document.getElementById('switchLink').onclick = () => {
      isSignup = !isSignup;
      document.getElementById('loginTitle').textContent = isSignup ? 'Create Account' : 'Sign In';
      document.getElementById('authBtn').textContent = isSignup ? 'Sign Up' : 'Sign In';
    };

    async function signup(u, p) {
      if (u.length < 3 || p.length < 4) return show('Username 3+, Password 4+');
      
      try {
        const res = await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });
        const data = await res.json();
        
        if (data.error) return show(data.error);
        show('Account created!');
        setTimeout(() => login(u, p), 1000);
      } catch (err) {
        show('Connection error');
      }
    }

    async function login(u, p) {
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });
        const data = await res.json();
        
        if (data.error) return show(data.error);
        
        userData = data.user;
        myName = u;
        els.loginScreen.style.display = 'none';
        
        socket = io(location.origin, { 
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000
        });
        
        initApp();
      } catch (err) {
        show('Connection error');
      }
    }

    function initApp() {
      points = userData.points || 0;

      els.connectionStatus.textContent = 'Connecting...';
      els.connectionStatus.className = 'status-connecting';
      els.connectionStatus.style.display = 'block';

      socket.on('connect', () => { 
        console.log('‚úÖ Connected');
        els.connectionStatus.textContent = '‚úì Connected'; 
        els.connectionStatus.className = 'status-connected';
        setTimeout(() => els.connectionStatus.style.display = 'none', 2000);
        socket.emit('join', { name: myName });
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        els.connectionStatus.textContent = '‚úó Connection Failed';
        els.connectionStatus.style.background = '#f55';
      });

      socket.on('disconnect', () => {
        console.log('Disconnected');
        els.connectionStatus.textContent = 'Disconnected';
        els.connectionStatus.style.display = 'block';
      });

      socket.on('userData', data => {
        servers = data.servers || {};
        friends = data.friends || {};
        renderServers();
        updateFriendsList();
      });

      socket.on('users', list => { 
        onlineUsers = list; 
        updatePlayers(); 
        updateFriendsList(); 
      });
      
      socket.on('userOnline', d => { 
        onlineUsers[d.name] = 'online'; 
        updatePlayers(); 
        updateFriendsList(); 
      });
      
      socket.on('userOffline', d => { 
        delete onlineUsers[d.name]; 
        updatePlayers(); 
        updateFriendsList(); 
      });

      socket.on('allServers', data => {
        allServers = data;
        if (document.getElementById('serverListView').style.display !== 'none') renderServerList();
      });

      socket.on('serverCreated', data => {
        servers[data.serverId] = data.server;
        renderServers();
      });

      socket.on('channelMessage', data => {
        if (currentServer === data.server && currentChannel === data.channel) {
          appendMessage(data.msg, document.getElementById('messages'));
        }
      });

      socket.on('messageHistory', data => {
        if (currentServer === data.server && currentChannel === data.channel) {
          const container = document.getElementById('messages');
          container.innerHTML = '';
          data.messages.forEach(msg => appendMessage(msg, container));
        }
      });

      socket.on('globalMessage', msg => {
        if (document.getElementById('globalView').style.display !== 'none') {
          appendMessage(msg, els.globalMessages);
        }
      });

      socket.on('friendRequest', d => {
        if (d.from === myName) return;
        friends[d.from] = 'pending';
        updateFriendsList();
        show(`Friend request from ${d.from}`);
      });

      socket.on('friendRequestSent', d => {
        friends[d.to] = 'sent';
        updateFriendsList();
        show(`Sent request to ${d.to}`);
      });

      socket.on('friendError', d => show(d.message));

      socket.on('dm', data => {
        if (currentDM === data.from) {
          appendMessage(data.msg, document.getElementById('dmMessages'));
        }
      });

      socket.on('acceptFriend', d => {
        if (friends[d.from]) {
          friends[d.from] = 'accepted';
          updateFriendsList();
          show(`${d.from} accepted your friend request!`);
        }
      });

      socket.on('friendAccepted', d => {
        if (friends[d.friend]) {
          friends[d.friend] = 'accepted';
          updateFriendsList();
        }
      });

      socket.on('friendRemoved', d => {
        if (friends[d.from]) {
          delete friends[d.from];
          updateFriendsList();
        }
      });

      socket.on('friendRemovedConfirm', d => {
        if (friends[d.username]) {
          delete friends[d.username];
          updateFriendsList();
          show(`Removed ${d.username}`);
        }
      });

      socket.on('accountDeleted', () => {
        alert('Your account has been permanently deleted.');
        location.reload();
      });

      socket.on('deleteError', d => show(d.message));

      // FIXED WebRTC Voice Calling Events
      socket.on('incomingCall', async ({ from, offer }) => {
        console.log('üìû Incoming call from:', from);
        currentCall = from;
        pendingIceCandidates = [];
        isRemoteDescriptionSet = false;
        window.pendingOffer = offer;
        
        document.getElementById('callUser').textContent = from;
        document.getElementById('callStatus').textContent = `Incoming Call`;
        document.getElementById('acceptCallBtn').style.display = 'block';
        document.getElementById('callUI').style.display = 'block';
        document.getElementById('callTimer').style.display = 'none';
        show(`üìû ${from} is calling!`);
      });

      socket.on('callAnswered', async ({ from, answer }) => {
        console.log('‚úÖ Call answered by:', from);
        try {
          if (!peerConnection) {
            console.error('No peer connection');
            return;
          }
          
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          console.log('‚úÖ Remote description set');
          isRemoteDescriptionSet = true;
          
          // Process queued ICE candidates
          while (pendingIceCandidates.length > 0) {
            const candidate = pendingIceCandidates.shift();
            try {
              await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
              console.log('‚úÖ Added queued ICE candidate');
            } catch (err) {
              console.error('Error adding queued candidate:', err);
            }
          }
        } catch (err) {
          console.error('Error setting remote description:', err);
          show('Call connection error');
          endCall(true);
        }
      });

      socket.on('iceCandidate', async ({ from, candidate }) => {
        console.log('üßä ICE candidate from:', from);
        if (!peerConnection) return;
        
        try {
          if (isRemoteDescriptionSet && peerConnection.remoteDescription) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            console.log('‚úÖ Added ICE candidate');
          } else {
            console.log('‚è≥ Queuing ICE candidate');
            pendingIceCandidates.push(candidate);
          }
        } catch (err) {
          console.error('Error with ICE candidate:', err);
        }
      });

      socket.on('callEnded', ({ from }) => {
        console.log('üìû Call ended by:', from);
        endCall(false);
        show(`Call ended`);
      });

      socket.on('callError', ({ message }) => {
        console.error('Call error:', message);
        show(`Call error: ${message}`);
        endCall(false);
      });

      loadSettings();
      updateClock(); 
      setInterval(updateClock, 60000);
      bindEvents();
      showTab('home');
    }

    // WebRTC Functions - COMPLETELY FIXED
    async function startCall(username) {
      try {
        console.log('üìû Starting call to:', username);
        
        if (!onlineUsers[username]) {
          show(`‚ùå ${username} is not online`);
          return;
        }
        
        currentCall = username;
        pendingIceCandidates = [];
        isRemoteDescriptionSet = false;
        
        document.getElementById('callUser').textContent = username;
        document.getElementById('callStatus').textContent = 'Getting microphone...';
        document.getElementById('callUI').style.display = 'block';
        document.getElementById('acceptCallBtn').style.display = 'none';
        document.getElementById('callTimer').style.display = 'none';
        
        // Get microphone
        localStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });
        console.log('üé§ Got microphone');
        
        document.getElementById('callStatus').textContent = 'Calling...';
        
        // Create peer connection
        peerConnection = new RTCPeerConnection(iceConfig);
        console.log('üîó Peer connection created');
        
        // Add tracks
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
          console.log('‚ûï Added track:', track.kind);
        });
        
        // Handle remote tracks
        peerConnection.ontrack = (event) => {
          console.log('üéµ Received remote track');
          if (!remoteAudio) {
            remoteAudio = new Audio();
            remoteAudio.autoplay = true;
            document.body.appendChild(remoteAudio);
          }
          remoteAudio.srcObject = event.streams[0];
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            console.log('üßä Sending ICE candidate');
            socket.emit('iceCandidate', { 
              to: username, 
              candidate: event.candidate.toJSON() 
            });
          }
        };
        
        // Monitor connection
        peerConnection.oniceconnectionstatechange = () => {
          console.log('ICE state:', peerConnection.iceConnectionState);
          if (peerConnection.iceConnectionState === 'connected') {
            document.getElementById('callStatus').textContent = 'Connected';
            document.getElementById('callTimer').style.display = 'block';
            startCallTimer();
            show('‚úÖ Connected!');
          } else if (peerConnection.iceConnectionState === 'failed') {
            show('‚ùå Connection failed');
            endCall(true);
          }
        };
        
        peerConnection.onconnectionstatechange = () => {
          console.log('Connection state:', peerConnection.connectionState);
        };
        
        // Create and send offer
        const offer = await peerConnection.createOffer({
          offerToReceiveAudio: true
        });
        await peerConnection.setLocalDescription(offer);
        console.log('üì§ Sending offer');
        
        socket.emit('callUser', { 
          to: username, 
          offer: peerConnection.localDescription.toJSON() 
        });
        
      } catch (err) {
        console.error('‚ùå Error:', err);
        show(err.message || 'Microphone access denied');
        endCall(false);
      }
    }

    async function acceptCall() {
      try {
        document.getElementById('acceptCallBtn').style.display = 'none';
        document.getElementById('callStatus').textContent = 'Getting microphone...';
        
        console.log('‚úÖ Accepting call from:', currentCall);
        
        // Validate we have a pending offer
        if (!window.pendingOffer) {
          throw new Error('No pending offer found');
        }
        
        // Get microphone
        localStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });
        console.log('üé§ Got microphone');
        
        document.getElementById('callStatus').textContent = 'Connecting...';
        
        // Create peer connection
        peerConnection = new RTCPeerConnection(iceConfig);
        console.log('üîó Peer connection created');
        
        // Handle remote tracks
        peerConnection.ontrack = (event) => {
          console.log('üéµ Received remote track');
          if (!remoteAudio) {
            remoteAudio = new Audio();
            remoteAudio.autoplay = true;
            document.body.appendChild(remoteAudio);
          }
          remoteAudio.srcObject = event.streams[0];
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            console.log('üßä Sending ICE candidate');
            socket.emit('iceCandidate', { 
              to: currentCall, 
              candidate: event.candidate.toJSON() 
            });
          }
        };
        
        // Monitor connection
        peerConnection.oniceconnectionstatechange = () => {
          console.log('ICE state:', peerConnection.iceConnectionState);
          if (peerConnection.iceConnectionState === 'connected') {
            document.getElementById('callStatus').textContent = 'Connected';
            document.getElementById('callTimer').style.display = 'block';
            startCallTimer();
            show('‚úÖ Connected!');
          } else if (peerConnection.iceConnectionState === 'failed') {
            show('‚ùå Connection failed');
            endCall(true);
          }
        };
        
        peerConnection.onconnectionstatechange = () => {
          console.log('Connection state:', peerConnection.connectionState);
        };
        
        // CRITICAL: Set remote description FIRST before adding tracks
        console.log('Setting remote description from offer...');
        await peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
        console.log('‚úÖ Remote description set, state:', peerConnection.signalingState);
        isRemoteDescriptionSet = true;
        
        // NOW add local tracks AFTER remote description is set
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
          console.log('‚ûï Added track:', track.kind);
        });
        
        // Process queued ICE candidates
        console.log('Processing', pendingIceCandidates.length, 'queued candidates');
        while (pendingIceCandidates.length > 0) {
          const candidate = pendingIceCandidates.shift();
          try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            console.log('‚úÖ Added queued ICE candidate');
          } catch (err) {
            console.error('Error adding queued candidate:', err);
          }
        }
        
        // Create and send answer
        console.log('Creating answer, signaling state:', peerConnection.signalingState);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        console.log('üì§ Sending answer');
        
        socket.emit('answerCall', { 
          to: currentCall, 
          answer: peerConnection.localDescription.toJSON() 
        });
        
      } catch (err) {
        console.error('‚ùå Error:', err);
        show(err.message || 'Microphone access denied');
        endCall(false);
      }
    }

    function startCallTimer() {
      callStartTime = Date.now();
      callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    function endCall(notifyOther = true) {
      console.log('üìû Ending call');
      
      if (notifyOther && currentCall) {
        socket.emit('endCall', { to: currentCall });
      }
      
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      if (remoteAudio) {
        remoteAudio.srcObject = null;
        if (remoteAudio.parentNode) remoteAudio.remove();
        remoteAudio = null;
      }
      
      if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
      }
      
      document.getElementById('callUI').style.display = 'none';
      currentCall = null;
      callStartTime = null;
      pendingIceCandidates = [];
      isRemoteDescriptionSet = false;
    }

    // Helper Functions
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: '2-digit', minute: '2-digit', hour12: true });
      const date = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      els.clock.textContent = `${time} CST, ${date}`;
    }

    function updatePlayers() { 
      els.playersOnline.textContent = `Players: ${Object.keys(onlineUsers).length}`; 
    }

    function renderServers() {
      const list = document.getElementById('servers');
      list.innerHTML = '<div class="srv add" id="addServerBtn">+</div>';
      Object.entries(servers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'srv';
        if (id === currentServer) div.classList.add('active');
        div.textContent = s.name[0].toUpperCase();
        div.dataset.id = id;
        div.dataset.name = s.name;
        div.onclick = () => switchServer(id);
        list.appendChild(div);
      });
      document.getElementById('addServerBtn').onclick = createServer;
    }

    function renderServerList() {
      const list = document.getElementById('serverList');
      list.innerHTML = '';
      Object.entries(allServers).forEach(([id, s]) => {
        const div = document.createElement('div');
        div.className = 'server-item';
        const joined = servers[id] ? true : false;
        div.innerHTML = `
          <h4>${s.name}</h4>
          <p>Owner: ${s.owner}</p>
          <p>Channels: ${s.channels.length}</p>
          <p>Members: ${s.members.length}</p>
          <div class="server-actions">
            ${joined ? '<span style="color:var(--online);">‚úì Joined</span>' : `<button class="join-btn" onclick="joinServer('${id}')">Join</button>`}
          </div>
        `;
        list.appendChild(div);
      });
    }

    window.joinServer = function(id) {
      const server = allServers[id];
      if (!server) return;
      servers[id] = server;
      socket.emit('joinServer', { serverId: id, username: myName });
      renderServers();
      renderServerList();
      show(`Joined ${server.name}!`);
    };

    function createServer() {
      const name = prompt('Server name:');
      if (!name) return;
      const id = Date.now().toString();
      const newServer = { name, channels: ['general'], members: [myName], owner: myName };
      socket.emit('createServer', { serverId: id, server: newServer });
    }

    function switchServer(id) {
      currentServer = id;
      currentChannel = null;
      const s = servers[id];
      const cl = document.getElementById('channelList');
      cl.innerHTML = '';
      s.channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'chan';
        div.innerHTML = `# ${ch} <span class="delete">√ó</span>`;
        div.onclick = e => {
          if (e.target.classList.contains('delete')) return removeChannel(ch);
          document.querySelectorAll('.chan').forEach(c => c.classList.remove('active'));
          div.classList.add('active');
          currentChannel = ch;
          els.chatTitle.textContent = `#${ch}`;
          document.getElementById('msgInput').placeholder = `Message #${ch}...`;
          document.getElementById('sendBtn').disabled = false;
          loadChannelMessages();
        };
        if (ch === 'general') { 
          div.classList.add('active'); 
          currentChannel = 'general'; 
          els.chatTitle.textContent = '#general'; 
        }
        cl.appendChild(div);
      });
      renderServers();
      document.getElementById('messages').innerHTML = '';
      if (currentChannel) loadChannelMessages();
      document.getElementById('sendBtn').disabled = false;
    }

    function loadChannelMessages() {
      socket.emit('getMessages', { server: currentServer, channel: currentChannel });
    }

    function removeChannel(ch) {
      if (!confirm(`Delete #${ch}?`)) return;
      servers[currentServer].channels = servers[currentServer].channels.filter(c => c !== ch);
      switchServer(currentServer);
    }

    function appendMessage(msg, container) {
      const own = msg.user === myName;
      const m = document.createElement('div');
      m.className = `msg ${own ? 'own' : ''}`;
      m.innerHTML = `<strong>[${msg.time}] ${msg.user}:</strong> ${msg.text}`;
      container.appendChild(m);
      container.scrollTop = container.scrollHeight;
    }

    function clearChat() {
      if (confirm('Clear chat display?')) {
        if (document.getElementById('globalView').style.display !== 'none') {
          els.globalMessages.innerHTML = '';
        } else if (document.getElementById('dmView').style.display !== 'none') {
          document.getElementById('dmMessages').innerHTML = '';
        } else {
          document.querySelector('#chatArea #messages').innerHTML = '';
        }
        show('Display cleared!');
      }
    }

    function sendChannel() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentServer || !currentChannel) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const msg = { user: myName, text, time };
      socket.emit('channelMessage', { server: currentServer, channel: currentChannel, msg });
      input.value = '';
    }

    function sendDM() {
      const input = document.getElementById('dmInput');
      const text = input.value.trim();
      if (!text || !currentDM) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const msg = { user: myName, text, time };
      appendMessage(msg, document.getElementById('dmMessages'));
      socket.emit('dm', { to: currentDM, msg });
      input.value = '';
    }

    function sendGlobal() {
      const text = els.globalMsgInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      socket.emit('globalMessage', { text, time });
      els.globalMsgInput.value = '';
    }

    function updateFriendsList() {
      const list = document.getElementById('friendsList');
      if (!list) return;
      list.innerHTML = '';
      Object.entries(friends).forEach(([name, status]) => {
        const div = document.createElement('div');
        const isOnline = onlineUsers[name] ? true : false;
        const showStatus = status === 'accepted' ? (isOnline ? 'online' : 'offline') : status;
        div.className = `friend ${showStatus === 'pending' || showStatus === 'sent' ? 'pending' : (isOnline ? '' : 'offline')}`;
        const color = isOnline ? 'var(--online)' : '#666';
        div.innerHTML = `<div class="status-dot" style="background:${color}"></div><span>${name}</span>`;
        
        if (status === 'pending') {
          const accept = document.createElement('button'); 
          accept.className = 'accept-btn'; 
          accept.textContent = 'Accept';
          accept.onclick = () => {
            friends[name] = 'accepted';
            updateFriendsList();
            socket.emit('acceptFriend', { to: name });
          };
          const reject = document.createElement('button'); 
          reject.className = 'reject-btn'; 
          reject.textContent = 'Reject';
          reject.onclick = () => socket.emit('removeFriend', { username: name });
          div.appendChild(accept); 
          div.appendChild(reject);
        } else if (status === 'sent') {
          const pending = document.createElement('span');
          pending.style.color = '#aaa';
          pending.style.fontSize = '11px';
          pending.style.marginLeft = '10px';
          pending.textContent = '(Sent)';
          div.appendChild(pending);
          
          const cancel = document.createElement('button');
          cancel.className = 'reject-btn';
          cancel.textContent = '‚úï';
          cancel.style.marginLeft = '8px';
          cancel.onclick = () => socket.emit('removeFriend', { username: name });
          div.appendChild(cancel);
        } else if (status === 'accepted') {
          div.onclick = () => openDM(name);
          
          const callBtn = document.createElement('button');
          callBtn.className = 'accept-btn';
          callBtn.textContent = 'üìû';
          callBtn.style.marginLeft = '8px';
          callBtn.onclick = (e) => {
            e.stopPropagation();
            startCall(name);
          };
          div.appendChild(callBtn);
          
          const remove = document.createElement('button');
          remove.className = 'reject-btn';
          remove.textContent = 'Remove';
          remove.style.marginLeft = '8px';
          remove.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`Remove ${name}?`)) socket.emit('removeFriend', { username: name });
          };
          div.appendChild(remove);
        }
        list.appendChild(div);
      });
    }

    function addFriend() {
      const input = document.getElementById('addFriendInput');
      const name = input.value.trim();
      if (!name || name === myName) return show('Invalid username');
      if (friends[name]) return show('Already in friend list');
      socket.emit('friendRequest', { to: name });
      input.value = '';
    }

    function openDM(user) {
      currentDM = user;
      showTab('dms');
      document.querySelector('#dmHeader span').textContent = `@${user}`;
      document.getElementById('dmMessages').innerHTML = '';
      document.getElementById('dmInput').placeholder = `Message @${user}...`;
      document.getElementById('dmSendBtn').disabled = false;
    }

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('app').style.display = tab === 'home' ? 'flex' : 'none';
      document.getElementById('serverListView').style.display = tab === 'serverlist' ? 'flex' : 'none';
      document.getElementById('dmView').style.display = tab === 'dms' ? 'flex' : 'none';
      document.getElementById('friendsView').style.display = tab === 'friends' ? 'flex' : 'none';
      document.getElementById('newsView').style.display = tab === 'news' ? 'flex' : 'none';
      document.getElementById('shopView').style.display = tab === 'shop' ? 'flex' : 'none';
      document.getElementById('gamesView').style.display = tab === 'games' ? 'flex' : 'none';
      document.getElementById('globalView').style.display = tab === 'global' ? 'flex' : 'none';
      document.getElementById('settingsView').style.display = tab === 'settings' ? 'block' : 'none';
      if (tab === 'serverlist') socket.emit('getServers');
      if (tab === 'news') updateNews();
      if (tab === 'shop') updateShop();
    }

    function updateNews() {
      const feed = document.getElementById('newsFeed');
      feed.innerHTML = '<div class="news-item"><h4>Welcome!</h4><p>GHOSTCORD v6.6 with fixed calling!</p></div>';
      feed.innerHTML += '<div class="news-item"><h4>Voice Calls</h4><p>Crystal clear voice calls with friends!</p></div>';
    }

    function updateShop() {
      document.getElementById('pointsDisplay').textContent = `Points: ${points}`;
      const items = document.getElementById('shopItems');
      items.innerHTML = '';
      const shop = { glow: {name:'Glow Effect',cost:50}, badge: {name:'VIP Badge',cost:100} };
      Object.entries(shop).forEach(([id, item]) => {
        const d = document.createElement('div'); 
        d.className = 'shop-item';
        d.innerHTML = `<div><h4>${item.name}</h4><p>${item.cost} pts</p></div><button class="buy-btn" ${points < item.cost ? 'disabled' : ''}>Buy</button>`;
        d.querySelector('.buy-btn').onclick = () => {
          if (points >= item.cost) { points -= item.cost; updateShop(); show(`Bought ${item.name}`); }
        };
        items.appendChild(d);
      });
    }

    function saveSettings() {
      const bio = document.getElementById('bioInput').value;
      const theme = document.getElementById('themeSelect').value;
      const status = document.getElementById('statusSelect').value;
      userData.bio = bio;
      userData.theme = theme;
      userData.status = status;
      loadSettings();
      show('Settings saved!');
    }

    function logout() {
      if (confirm('Logout?')) location.reload();
    }

    function deleteAccount() {
      const username = myName;
      if (confirm(`‚ö†Ô∏è DELETE "${username}"? This CANNOT be undone!`)) {
        if (confirm(`Type "${username}" to confirm:`)) {
          const confirmName = prompt(`Type "${username}":`);
          if (confirmName === username) socket.emit('deleteAccount');
          else show('Cancelled');
        }
      }
    }

    function loadSettings() {
      document.body.dataset.theme = userData.theme || 'dark';
      els.userName.textContent = myName;
      els.userStatus.textContent = userData.status || 'online';
      els.userStatus.style.color = { 
        online: 'var(--online)', idle: 'var(--idle)', 
        dnd: 'var(--dnd)', invisible: 'var(--invisible)' 
      }[userData.status] || 'var(--online)';
      if (userData.avatar) els.userAvatar.src = userData.avatar;
    }

    function bindEvents() {
      document.getElementById('addChannelBtn').onclick = () => {
        const name = prompt('Channel name:');
        if (name && currentServer && !servers[currentServer].channels.includes(name)) {
          servers[currentServer].channels.push(name);
          switchServer(currentServer);
        }
      };
      document.getElementById('sendBtn').onclick = sendChannel;
      document.getElementById('msgInput').onkeydown = e => { 
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChannel(); } 
      };
      document.getElementById('dmSendBtn').onclick = sendDM;
      document.getElementById('dmInput').onkeydown = e => { 
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDM(); } 
      };
      els.globalSendBtn.onclick = sendGlobal;
      els.globalMsgInput.onkeydown = e => { 
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobal(); } 
      };
      document.getElementById('addFriendBtn').onclick = addFriend;
      document.querySelectorAll('.tab').forEach(t => t.onclick = () => showTab(t.dataset.tab));
      document.getElementById('saveSettingsBtn').onclick = saveSettings;
      document.getElementById('logoutBtn').onclick = logout;
      document.getElementById('deleteAccountBtn').onclick = deleteAccount;
      document.getElementById('acceptCallBtn').onclick = acceptCall;
      document.getElementById('endCallBtn').onclick = () => endCall(true);
      els.clearChatBtn.onclick = clearChat;
      els.clearDmBtn.onclick = clearChat;
      els.clearGlobalBtn.onclick = clearChat;
    }
  </script>
  <script src="mobile.js"></script>
</body>
</html>









